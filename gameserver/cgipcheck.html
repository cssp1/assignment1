<!DOCTYPE html>
<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>$GAME_NAME$ Support Tools</title>
<link rel="icon" href="$GAME_LOGO_URL$">
<link rel="stylesheet" href="$SPIN_PUBLIC_S3_URL$/jquery-ui-themes/smoothness/jquery-ui.css" />
<script src="$SPIN_PUBLIC_S3_URL$/jquery-2.1.4.min.js"></script>
<script src="$SPIN_PUBLIC_S3_URL$/jquery-ui-1.11.4.min.js"></script>
<script src="$SPIN_PUBLIC_S3_URL$/jquery.elastic.source.js"></script>
<script src="$SPIN_PUBLIC_S3_URL$/jquery.flot.min.js"></script>
<script src="$SPIN_PUBLIC_S3_URL$/jquery.flot.time.min.js"></script>
<script src="$SPIN_PUBLIC_S3_URL$/jquery.flot.threshold.min.js"></script>
<script src="$SPIN_PUBLIC_S3_URL$/jquery.flot.navigate.min.js"></script>
<style type="text/css">
body { font-size: 14px;
font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue",sans-serif;
background: #dddddd; color: #000000;
padding:0; margin: 10px; }
label { font-size: 14px; }
select { height:28px; font-size: 16px; }
input, .ui-widget input { font-family: monospace; font-size: 16px; height:28px; padding:0; }
/* wide inputs */
input#payment_id, input#battlehouse_id { width: 400px; }
.spin_button { width: 150px; height: 35px; font-size: 16px; padding:0; margin-left: 5px; margin-right: 5px; }
.spin_button_tiny { line-height: 0px; font-size: 8px !important; height: 12px; }
.spin_radio { vertical-align: bottom; }
.ui-helper-reset { line-height: 100%; font-size: 14px; }
.ui-widget select { font-size: 18px; }
.ui-widget button { font-size: 14px; }
.ui-tabs { font-size: 14px; }
.ui-tabs-nav { line-height: 120%; }
table, th, td { border: 1px solid #808080; border-collapse: collapse; padding: 0px; }
.spin_chat_report_td { padding: 5px; }
.spin_server_status_td { padding: 0px 2px; }
.spin_td_nowrap { white-space: nowrap; }
.spin_server_status_td_div { overflow: hidden; }
</style>

<script type="text/javascript">
// Copyright (c) 2015 Battlehouse Inc. All rights reserved.
// Use of this source code is governed by an MIT-style license that can be
// found in the LICENSE file.
var spin_token = '$SPIN_TOKEN$'; var spin_token_data = $SPIN_TOKEN_DATA$;
var spin_url = '$SPIN_URL$'; var spin_game_id = '$SPIN_GAME_ID$';
var spin_token_cookie_name = '$SPIN_TOKEN_COOKIE_NAME$';
var spin_login_hint_cookie_name = '$SPIN_LOGIN_HINT_COOKIE_NAME$';
var spin_token_domain = '$SPIN_TOKEN_DOMAIN$';
var spin_giveable_items = $SPIN_GIVEABLE_ITEMS$;
var spin_regions = $SPIN_REGIONS$;
var spin_direct_multiplex = $SPIN_DIRECT_MULTIPLEX$;
var spin_ai_base_ids = $SPIN_AI_BASE_IDS$;
var spin_log_bookmark = $SPIN_LOG_BOOKMARK$;
var spin_log_bookmark_dirty = true;
var spin_ssl_available = $SPIN_SSL_AVAILABLE$;
var spin_wss_available = $SPIN_WSS_AVAILABLE$;
var visit_base_url = '$VISIT_BASE_URL$';

var delete_cookie = function() {
    document.cookie = spin_token_cookie_name+'=;path=/;domain=.'+spin_token_domain+';expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    document.cookie = spin_login_hint_cookie_name+'=;path=/;domain=.'+spin_token_domain+';expires=Thu, 01 Jan 1970 00:00:01 GMT;';
}

var gui_locked = false;
var lock_gui = function() { if(!gui_locked) { gui_locked = true; $('\#loading_dialog').dialog({modal:true,closeOnEscape:false,buttons:[]}); } };
var unlock_gui = function() { if(gui_locked) { gui_locked = false; $('\#loading_dialog').dialog('close'); } };
var display_error = function(msg) { $('\#error_dialog_msg')[0].innerHTML = msg; $('\#error_dialog').dialog({modal:true,width:'auto'}); };
var display_response = function(msg) { $('\#response_dialog_msg')[0].innerHTML = msg; $('\#response_dialog').dialog({modal:true,width:'auto'}); };

var confirm_dialog = function(msg, yes_cb) {
    $('#confirm_dialog_msg')[0].innerHTML = msg;
    $('#confirm_dialog').dialog({
        modal: true, autoOpen: true,
        width: 'auto', resizable: false,
        buttons: {
            'No': function () {
                $(this).dialog('close');
            },
            'Yes': (function (_yes_cb) { return function () {
                _yes_cb();
                $(this).dialog('close');
            }; })(yes_cb)
        }
    });
};

var payment_lookup = function() {
    var payment_id = $("#payment_id")[0].value;
    if(payment_id) {
        $('#per_payment').hide();
        $('#payment_lookup_output')[0].value = '';
        send_request('payment', 'lookup', {'payment_id': payment_id}, function(result) {
            var data = JSON.parse(result);
            $('#per_payment').show();
            $('#payment_lookup_output')[0].value = JSON.stringify(data, null, 2);
            $('#payment_lookup_output').elastic("update");

            var status = 'Unknown';
            var is_disputed = false, is_refundable = false;

            if('disputes' in data) {
                for(var i = 0; i < data['disputes'].length; i++) {
                    if(data['disputes'][i]['status'] != 'resolved') {
                        is_disputed = true;
                        break;
                    }
                }
            }
            if(('refundable_amount' in data) && parseFloat(data['refundable_amount']['amount']) > 0) {
                is_refundable = true;
            }

            if(is_refundable) {
                status = '<font color="#00c000">Paid. We will receive payment.</font>';
            } else {
                status = '<font color="#ff0000">Not Paid. We will not receive payment (check "actions" below for details).</font>';
            }

            if(is_disputed) {
                status += ' <font color="#ff0000">This payment has been disputed and needs to be resolved.</font>';
            }

            $('#payment_status')[0].innerHTML = status;

            if(spin_token_data['roles'].indexOf('ADMIN') != -1) {
                $('#payment_tools').show();

                if(is_refundable) {
                    $('#payment_refund_button').removeAttr('disabled');
                    $('#payment_refund_button').click((function (_data) { return function() {
                        var do_refund_cb = (function (__data) { return function() {
                            $('#payment_refund_button').attr('disabled', 'disabled');
                            send_request('payment', 'refund', {'payment_id': __data['id'],
                                                               'currency': __data['refundable_amount']['currency'],
                                                               'amount': __data['refundable_amount']['amount']},
                                         function(result) { display_response(result); });
                        }; })(_data);
                        confirm_dialog('Refund this payment for '+_data['refundable_amount']['amount']+' '+_data['refundable_amount']['currency']+'?',
                                       do_refund_cb);
                    }; })(data));
                } else {
                    $('#payment_refund_button').attr('disabled', 'disabled');
                }

                if(is_disputed) {
                    $('input:radio[name=payment_resolve_reason]').removeAttr('disabled');
                    $('#payment_resolve_button').removeAttr('disabled');
                    $('#payment_resolve_button').click((function (_data) { return function() {
                        $('#payment_resolve_button').attr('disabled', 'disabled');
                        send_request('payment', 'resolve_dispute', {'payment_id': _data['id'],
                                                                    'reason': $('input:radio[name=payment_resolve_reason]:checked').val()},
                                     function(result) { display_response(result); });
                    }; })(data));
                } else {
                    $('input:radio[name=payment_resolve_reason]').attr('disabled', 'disabled');
                    $('#payment_resolve_button').attr('disabled', 'disabled');
                }
            }
        });
    }
};

var get_ident_type = function() {
    return {0: 'user_id', 1: 'facebook_id', 2: 'battlehouse_id'}[$('#player_lookup').tabs("option","active")];
};

var get_ident = function() {
    var t = get_ident_type();
    if(t == 'user_id') {
        var suser_id = $("#user_id")[0].value;
        if(!suser_id) { return null; }
        var user_id = parseInt(suser_id);
        if(isNaN(user_id)) { alert("Bad User ID value: "+suser_id); return null; }
        return {'user_id':user_id};
    } else if(t == 'facebook_id') {
        var sid = $("#facebook_id")[0].value;
        if(!sid) { return null; }
        var id = parseInt(sid);
        if(isNaN(id)) { alert("Bad Facebook ID value: "+sid); return null; }
        return {'facebook_id':id};
    } else if(t == 'battlehouse_id') {
        var sid = $("#battlehouse_id")[0].value;
        if(!sid) { return null; }
        if(sid.length != 36) { alert("Bad Battlehouse ID value: "+sid); return null; }
        return {'battlehouse_id':sid};
    }
};

var pretty_ident = function(ident) {
    if('user_id' in ident) { return 'User ID '+ident['user_id'].toString(); }
    if('facebook_id' in ident) { return 'Facebook ID '+ident['facebook_id'].toString(); }
    if('battlehouse_id' in ident) { return 'Battlehouse ID '+ident['battlehouse_id'].toString(); }
    return 'unknown ident';
};

var check_ui_reason = function(reason) {
    if(!reason || reason.length < 1) {
        display_error('Please type the reason you are taking this action in the "Reason" field');
        return null;
    }
    return reason;
};

var check_mandatory_input = function(input_value, input_field) {
    if(!input_value || input_value.length < 1) {
        display_error('Please enter a value in the ' + input_field + ' field');
        return null;
    }
    return input_value;
};

var send_request = function(path, method, args, cb, async, fail_cb) {
    args['spin_token'] = spin_token; args['method'] = method;
    $.ajax(spin_url+'/'+path, { data: args,
                       dataType: 'json',
                       success: (function (_cb, _fail_cb, _async) { return function(result) {
                           if(!async) { unlock_gui(); }
                           if(result['error']) {
                               display_error(result['error']);
                               if(_fail_cb) { _fail_cb(result['error']); }
                           } else {
                               if(_cb) { _cb(result['result']); }
                           }
                       }; })(cb, fail_cb, async),
                       error: (function (_fail_cb, _async) { return function(xhr, status, msg) {
                           if(!async) { unlock_gui(); }
                           display_error("XHR Error: "+msg);
                           if(_fail_cb) { _fail_cb(result['error']); }
                       }; })(fail_cb, async),
                       timeout: 75*1000, type: 'POST' });
    if(!async) { lock_gui(); }
};

var method_lookup = function() {
    var ident = get_ident();
    if(ident) {
        $('#per_player').hide();
        $('#lookup_output')[0].value = '';
        send_request('player', 'lookup', ident, function(result) {
            $('#per_player').show();
            $('#player_tools').show();
            $('#lookup_output')[0].value = result.toString();
            $('#lookup_output').elastic("update");
        });
    }
}

var method_give_gamebucks = function() {
    var ident = get_ident();
    var amount = $("#gamebucks_amount").spinner("value");
    var ui_reason = check_ui_reason($("#give_item_gamebucks_score_reason")[0].value);
    if(ident && !isNaN(amount) && amount > 0 && ui_reason) {
        send_request('player', 'give_item', $.extend(ident, {'spec':'$GAMEBUCKS_ITEM$', 'stack':amount, 'undiscardable':1, 'log':'PCHECK', 'ui_reason':ui_reason}), function(result) { alert("Success!"); });
    }
};
var method_set_pvp_score = function() {
    var ident = get_ident();
    var amount = $("#pvp_score_amount").spinner("value");
    var ui_reason = check_ui_reason($("#give_item_gamebucks_score_reason")[0].value);
    if(ident && !isNaN(amount) && amount > 0 && ui_reason) {
        send_request('player', 'modify_scores', $.extend(ident, {'stat':'trophies_pvp', 'value':amount, 'update_method':'=', 'log':'PCHECK', 'ui_reason':ui_reason}), function(result) { alert("Success!"); });
    }
};
var method_add_pvp_score = function() {
    var ident = get_ident();
    var amount = $("#pvp_score_amount").spinner("value");
    var ui_reason = check_ui_reason($("#give_item_gamebucks_score_reason")[0].value);
    if(ident && !isNaN(amount) && amount > 0 && ui_reason) {
        send_request('player', 'modify_scores', $.extend(ident, {'stat':'trophies_pvp', 'value':amount, 'update_method':'+=', 'log':'PCHECK', 'ui_reason':ui_reason}), function(result) { alert("Success!"); });
    }
};

var method_check_idle = function() {
    var ident = get_ident();
    if(ident) {
        send_request('player', 'check_idle', ident, function(result) { alert("Success!"); });
    }
};
var method_clear_cooldown = function() {
    var ident = get_ident();
    var name = $("#cooldown_name")[0].value;
    var ui_reason = check_ui_reason($("#cooldown_reason")[0].value);
    if(ident && name && ui_reason) {
        send_request('player', 'clear_cooldown', $.extend(ident, {'name':name, 'ui_reason':ui_reason}), function(result) { alert("Success!"); });
    }
};
var method_remove_aura = function(aura_name, optional_data) {
    var ident = get_ident();
    if(ident && aura_name) {
        var params = $.extend(ident, {'aura_name':aura_name});
        if(optional_data) {
            params['data'] = JSON.stringify(optional_data);
        }
        send_request('player', 'remove_aura', params, function(result) { alert("Success!"); });
    }
};

var has_regions_with_tag = function(t) {
    for(var i = 0; i < spin_regions.length; i++) {
        var region = spin_regions[i];
        if(('tags' in region) && region['tags'].indexOf(t) >= 0) {
            return true;
        }
    }
    return false;
};
var has_anti_alt_regions = function() { return has_regions_with_tag('anti_alt'); };
var has_anti_vpn_regions = function() { return has_regions_with_tag('anti_vpn'); };
var has_anti_refresh_regions = function() { return has_regions_with_tag('anti_refresh'); };

var has_non_anti_alt_regions = function() {
    for(var i = 0; i < spin_regions.length; i++) {
        var region = spin_regions[i];
        if(('tags' in region) && region['tags'].indexOf('anti_alt') >= 0) {
            // nothing
        } else {
            return true;
        }
    }
    return false;
};

var method_change_region_imprison = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#change_region_reason")[0].value);
    var on_complete = function(result) {
        alert("Success! Remember to send the player a message explaining what happened!");
    };

    if(ident && ui_reason) {
        send_request('player', 'change_region', $.extend({}, ident, {'new_region':'prison', 'ui_reason':ui_reason}),
                     (function (_ident, _on_complete) { return function(result) {
                         send_request('player', 'apply_aura', $.extend({}, _ident, {'aura_name':'region_banished','duration':3122064000,'data':JSON.stringify({'tag':'imprisoned'})}),
                         (function (__ident, __on_complete) { return function(result) {
                             __on_complete(result);
                         }; })(_ident, _on_complete));
                     }; })(ident, on_complete));
    }
};

var method_change_region = function() {
    var ident = get_ident();
    var new_region = $("#change_region_destination")[0].value;
    var ui_reason = check_ui_reason($("#change_region_reason")[0].value);
    var alt_banish_duration = (has_anti_alt_regions() && $("#change_region_do_alt_banish")[0].checked) ? ($("#region_alt_banish_duration").spinner("value") * 3600) : 0;
    var vpn_banish_duration = (has_anti_vpn_regions() && $("#change_region_do_vpn_banish")[0].checked) ? ($("#region_vpn_banish_duration").spinner("value") * 3600) : 0;
    var refresh_banish_duration = (has_anti_refresh_regions() && $("#change_region_do_refresh_banish")[0].checked) ? ($("#region_refresh_banish_duration").spinner("value") * 3600) : 0;
    var include_alts = $("#region_include_alts")[0].checked ? '1' : '0';
    var include_alts_recursive = $("#region_include_alts_recursive")[0].checked ? '1' : '0';
    var aggressive_alt_identification = $("#region_aggressive_alt_identification")[0].checked ? '1' : '0';

    var on_complete = function(result) {
        alert("Success! Remember to send the player a message explaining what happened!");
    };

    if(ident && new_region && ui_reason) {
        send_request('player', 'change_region', $.extend({}, ident, {'new_region':new_region, 'ui_reason':ui_reason}),
                     (function (_ident, _on_complete, _alt_banish_duration, _refresh_banish_duration) { return function(result) {
                         if(_alt_banish_duration === 0 && _refresh_banish_duration === 0) {
                             _on_complete(result);
                         } else {
                             send_request('player', 'apply_aura', $.extend({}, _ident, {'aura_name':'region_banished','duration':_alt_banish_duration,'data':JSON.stringify({'tag':'anti_alt'})}),
                                          (function (__ident, __on_complete, __refresh_banish_duration) { return function(result) {
                                              if(__refresh_banish_duration === 0) {
                                                  __on_complete(result);
                                              } else {
                                                  send_request('player', 'apply_aura', $.extend({}, __ident, {'include_alts':include_alts, 'include_alts_recursive': include_alts_recursive, 'aggressive_alt_identification': aggressive_alt_identification, 'aura_name':'region_banished','duration':__refresh_banish_duration,'data':JSON.stringify({'tag':'anti_refresh'})}), __on_complete);
                                              }
                                          }; })(_ident, _on_complete, _refresh_banish_duration));
                         }
                     }; })(ident, on_complete, alt_banish_duration, refresh_banish_duration));
    }
};
var method_give_item = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#give_item_gamebucks_score_reason")[0].value);
    var spec = $("#item_to_give_text")[0].value || $("#item_to_give")[0].value;
    var stack = $("#item_to_give_qty").spinner("value");
    var level = $("#item_to_give_level").spinner("value");
    var ui_name = stack.toFixed() + "x " + spec + ((level != 1) ? (" L"+level.toString()) : "");

    if(ident && spec && stack > 0 && ui_reason) {
        var do_send = true;
        if(stack > 1000 && ['gamebucks', 'token'].indexOf(spec) < 0) {
            alert("Error: Cannot give more than 1000x of " + spec);
            do_send = false;
        } else if(stack > 10 || level > 1) {
            do_send = confirm("You are trying to give " + ui_name + ".\n\nAre you sure you want to do this?");
        }
        if(do_send) {
            send_request('player', 'give_item', $.extend(ident, {'spec': spec, 'stack':stack, 'level':level, 'ui_reason':ui_reason}), (function(_ui_name) { return function(result) { alert("Successfully gave " + _ui_name + "!"); }; })(ui_name));
        }
    }
};
var method_chat_gag = function(duration) {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#chat_reason")[0].value);
    var include_alts = $("#chat_gag_ungag_include_alts")[0].checked ? '1' : '0';
    var include_alts_recursive = $("#chat_gag_ungag_include_alts_recursive")[0].checked ? '1' : '0';
    var aggressive_alt_identification = $("#chat_gag_ungag_aggressive_alt_identification")[0].checked ? '1' : '0';
    if(ident && ui_reason) {
        var args = $.extend(ident, {'ui_reason':ui_reason, 'include_alts':include_alts, 'include_alts_recursive': include_alts_recursive, 'aggressive_alt_identification':aggressive_alt_identification});
        if(duration > 0) {
            args['duration'] = duration;
        }
        send_request('player', 'chat_gag', args, function(result) { alert("Success!"); });
    }
};
var method_chat_ungag = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#chat_reason")[0].value);
    var include_alts = $("#chat_gag_ungag_include_alts")[0].checked ? '1' : '0';
    var include_alts_recursive = $("#chat_gag_ungag_include_alts_recursive")[0].checked ? '1' : '0';
    var aggressive_alt_identification = $("#chat_gag_ungag_aggressive_alt_identification")[0].checked ? '1' : '0';
    if(ident && ui_reason) {
        send_request('player', 'chat_ungag', $.extend(ident, {'ui_reason':ui_reason, 'include_alts':include_alts, 'include_alts_recursive': include_alts_recursive, 'aggressive_alt_identification':aggressive_alt_identification}), function(result) { alert("Success!"); });
    }
};
var method_chat_abuse_clear = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#chat_reason")[0].value);
    if(ident && ui_reason) {
        send_request('player', 'chat_abuse_clear', $.extend(ident, {'ui_reason':ui_reason}), function(result) { alert("Success!\n"+result.toString()); });
    }
};
var method_chat_abuse_violate = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#chat_reason")[0].value);
    var ui_player_reason = check_ui_reason($("#chat_abuse_player_reason")[0].value);
    if(ident && ui_reason && ui_player_reason) {
        send_request('player', 'chat_abuse_violate', $.extend(ident, {'ui_reason':ui_reason, 'ui_player_reason':ui_player_reason}), function(result) { alert("Success!\n"+result.toString()); });
    }
};
var method_ban = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#ban_reason")[0].value);
    args = {'ui_reason': ui_reason,
            'include_alts': $("#ban_include_alts")[0].checked ? '1' : '0',
            'include_alts_recursive': $("#ban_include_alts_recursive")[0].checked ? '1' : '0',
            'aggressive_alt_identification': $("#ban_aggressive_alt_identification")[0].checked ? '1' : '0',
            'remove_from_map': $("#ban_remove_from_map")[0].checked ? '1' : '0'
           };

    if( $("#ban_public_announce")[0].checked) {
        args['public_announce'] = '1';
        args['ui_public_message'] = $("#ban_public_message")[0].value;
    }

    if(ident && ui_reason) {
        send_request('player', 'ban', $.extend(ident, args), function(result) { display_response("Success!"); });
    }
};
var method_unban = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#ban_reason")[0].value);
    if(ident && ui_reason) {
        send_request('player', 'unban', $.extend(ident, {'ui_reason':ui_reason}), function(result) { display_response("Success!"); });
    }
};
var method_unmerge_bh_id = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#alts_vpn_migrate_reason")[0].value);
    args = {'ui_reason': ui_reason};
    if(ident && ui_reason) {
        send_request('player', 'unmerge_bh_id', $.extend(ident, args), function(result) { display_response("Success!"); });
    }
}
var method_vpn_excuse = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#alts_vpn_migrate_reason")[0].value);
    args = {'ui_reason': ui_reason};

    if(ident && ui_reason) {
        send_request('player', 'vpn_excuse', $.extend(ident, args), function(result) { display_response("Success!"); });
    }
};
var method_vpn_unexcuse = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#alts_vpn_migrate_reason")[0].value);
    if(ident && ui_reason) {
        send_request('player', 'vpn_unexcuse', $.extend(ident, {'ui_reason':ui_reason}), function(result) { display_response("Success!"); });
    }
};
var method_kick_alliance_member = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#alliance_player_reason")[0].value);
    if(ident && ui_reason) {
        send_request('player', 'kick_alliance_member', $.extend(ident, {'ui_reason':ui_reason}), function(result) { alert("Success!"); });
    }
};
var method_demote_alliance_leader = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#alliance_player_reason")[0].value);
    if(ident && ui_reason) {
        send_request('player', 'demote_alliance_leader', $.extend(ident, {'ui_reason':ui_reason}), function(result) { alert("Success! The new Clan leader is user_id "+result['new_leader_id'].toString()); });
    }
};
var method_change_alliance_name = function() { method_change_alliance_info('name'); }
var method_change_alliance_tag = function() { method_change_alliance_info('tag'); }
var method_change_alliance_info = function(info_type) {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#alliance_player_reason")[0].value);
    var new_alliance_info = check_mandatory_input($("#alliance_new_value")[0].value, 'clan name or tag');
    if(info_type === 'tag' && new_alliance_info.length != 3) {
        display_error('Clan tags must be three characters in length');
        return;
    }
    if(ident && ui_reason && new_alliance_info) {
        send_request('player', 'change_alliance_info', $.extend(ident, {'ui_reason':ui_reason, 'info_type': info_type, 'new_alliance_info':new_alliance_info}, ), function(result) { alert("Success! The new Clan" + info_type + " is " + result['new_alliance_info'].toString()); });
    }
}
var method_mark_uninstalled = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#privacy_reason")[0].value);
    if(ident && ui_reason) {
        send_request('player', 'mark_uninstalled', $.extend(ident, {'ui_reason':ui_reason,'reason':'PCHECK'}), function(result) { alert("Success! Personal info removed."); });
    }
};
var method_make_developer = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#make_developer_reason")[0].value);
    if(ident && ui_reason) {
        send_request('player', 'make_developer', $.extend(ident, {'ui_reason':ui_reason}), function(result) { alert("Success!"); });
    }
};
var method_unmake_developer = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#make_developer_reason")[0].value);
    if(ident && ui_reason) {
        send_request('player', 'unmake_developer', $.extend(ident, {'ui_reason':ui_reason}), function(result) { alert("Success!"); });
    }
};

var method_make_patron = function(patron_level) {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#make_patron_reason")[0].value);
    if(ident && ui_reason) {
        send_request('player', 'make_patron', $.extend(ident, {'patron_level':patron_level}), function(result) { alert("Success!"); });
    }
};
var method_unmake_patron = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#make_patron_reason")[0].value);
    if(ident && ui_reason) {
        send_request('player', 'unmake_patron', $.extend(ident, {'ui_reason':ui_reason}), function(result) { alert("Success!"); });
    }
};

var method_migrate_spin_id = function(new_spin_id) {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#alts_vpn_migrate_reason")[0].value);
    if(ident && ui_reason) {
        if(!ident['user_id']) {
            display_error('Please look up this player by User ID');
            return;
        }
        var spin_id = ident['user_id'];
        if(!new_spin_id) {
            display_error("Please fill in the ID of the player's new account");
            return;
        }
        send_request('player', 'migrate_spin_id', $.extend(ident, {'spin_id': spin_id, 'new_spin_id': new_spin_id, 'ui_reason': ui_reason}), function(result) { alert("Success!"); });
    }
};

var method_force_migrate_spin_id = function() {
    var ident = get_ident();
    var new_bh_id = $("#migrate_account_battlehouse_id")[0].value;
    var ui_reason = check_ui_reason($("#alts_vpn_migrate_reason")[0].value);
    if(ident && ui_reason) {
        if(!ident['user_id']) {
            display_error('Please look up this player by User ID');
            return;
        }
        var spin_id = ident['user_id'];
        if(!new_bh_id) {
            display_error("Please fill in the Battlehouse ID of the player's new account");
            return;
        }
        send_request('player', 'force_migrate_spin_id', $.extend(ident, {'spin_id': spin_id, 'new_bh_id': new_bh_id, 'ui_reason': ui_reason}), function(result) { alert("Success!"); });
    }
};

var method_ignore_or_unignore_alt = function(other_id, method_name) {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#alts_vpn_migrate_reason")[0].value);
    if(ident && ui_reason) {
        if(!ident['user_id']) {
            display_error('Please look up this player by User ID');
            return;
        }
        if(!other_id) {
            display_error('Please fill in the ID of the other player you want to ignore or un-ignore');
            return;
        }
        send_request('player', method_name, $.extend(ident, {'other_id': other_id, 'ui_reason': ui_reason}), (function (_method_name, _my_id, _other_id, _ui_reason) { return function(result) {
            send_request('player', _method_name, {'user_id': _other_id, 'other_id': _my_id, 'ui_reason': _ui_reason}, (function (__method_name, __my_id, __other_id) { return function(result) {
                alert({'ignore_alt':"Ignored (marked as NOT alt accounts): ", 'unignore_alt':"Un-ignored accounts: "}[__method_name]+__my_id.toString()+" and "+__other_id.toString()+"!");
            }; })(_method_name, _my_id, _other_id));
        }; })(method_name, ident['user_id'], other_id, ui_reason));
    }
};
var method_ignore_alt = function(other_id) { method_ignore_or_unignore_alt(other_id, 'ignore_alt'); };
var method_unignore_alt = function(other_id) { method_ignore_or_unignore_alt(other_id, 'unignore_alt'); };

var method_clear_alias = function(cooldown) {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#chat_reason")[0].value);
    if(ident && ui_reason) {
        if(!ident['user_id']) {
            display_error('Please look up this player by User ID');
            return;
        }

        send_request('player', 'clear_alias', $.extend({}, ident, {'ui_reason':ui_reason}), (function(_ident, _ui_reason, _cooldown) { return function(result) {
            if(_cooldown > 0) {
                send_request('player', 'apply_aura', $.extend({}, _ident, {'ui_reason':_ui_reason,'aura_name':'alias_gagged','duration':_cooldown}),
                             (function (__ident, __cooldown) { return function(result) {
                                 alert("Cleared alias from player "+__ident['user_id'].toString()+" and added cooldown for "+(__cooldown/3600).toFixed(0)+" hours");
                             }; })(_ident, _cooldown));
            } else {
                alert("Cleared alias from player "+_ident['user_id'].toString());
            }
        }; })(ident, ui_reason, cooldown));
    }
};
var method_chat_official = function() {
    var ident = get_ident();
    if(ident) {
        send_request('player', 'chat_official', $.extend(ident, {}), function(result) { alert("Success!"); });
    }
};
var method_chat_unofficial = function() {
    var ident = get_ident();
    if(ident) {
        send_request('player', 'chat_unofficial', $.extend(ident, {}), function(result) { alert("Success!"); });
    }
};

var method_chat_block_or_unblock = function(other_id, method_name) {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#chat_reason")[0].value);
    if(ident && ui_reason) {
        if(!ident['user_id']) {
            display_error('Please look up this player by User ID');
            return;
        }
        if(!other_id) {
            display_error('Please fill in the ID of the other player you want to block/unblock');
            return;
        }
        send_request('player', method_name, $.extend(ident, {'other_id': other_id, 'ui_reason': ui_reason}), (function (_method_name, _my_id, _other_id, _ui_reason) { return function(result) {
            send_request('player', _method_name, {'user_id': _other_id, 'other_id': _my_id, 'ui_reason': _ui_reason}, (function (__method_name, __my_id, __other_id) { return function(result) {
                alert({'chat_block':"Blocked", 'chat_unblock':"Unblocked"}[__method_name]+" communication between players "+
                      __my_id.toString()+" and "+__other_id.toString()+"!");
            }; })(_method_name, _my_id, _other_id));
        }; })(method_name, ident['user_id'], other_id, ui_reason));
    }
};
var method_chat_block = function(other_id) { method_chat_block_or_unblock(other_id, 'chat_block'); };
var method_chat_unblock = function(other_id) { method_chat_block_or_unblock(other_id, 'chat_unblock'); };

var method_chat_get = function() {
    var ident = get_ident();
    var chat_message_count = $("#chat_message_count")[0].value;
    if(ident) {
        var time_now = (new Date()).getTime()/1000;
        send_request('chat', 'get', $.extend(ident, {'start_time':Math.floor(time_now - 7*86400), 'chat_message_count':chat_message_count}), (function (ui_ident) { return function(result) {
            display_chat_messages(ui_ident, result);
        }; })(pretty_ident(ident)));
    }
};

// open a new window to display a blob of preformatted text
var display_text_blob = function(raw_text) {
    if(0) { // doesn't handle UTF-8 correctly?
        var text_blob = new Blob([raw_text], {'type': 'text/plain;charset=UTF-8', 'encoding':'UTF-8'});
        var text_blob_url = URL.createObjectURL(text_blob);
        window.open(text_blob_url, '_blank');
    } else {
        var w = window.open('', '_blank');
        w.document.open();
        w.document.write('<html><head><meta charset="UTF-8"></head><body><pre>');
        w.document.write(quote_for_html(raw_text));
        w.document.write('</pre></body></html>');
        w.document.close();
    }
}

// the server returns an array of raw JSON for chat messages - convert to GUI form
var display_chat_messages = function(ui_ident, result) {
    var lines = ['Chat messages sent by '+ui_ident+' in last week (newest at top)',
                 '',
                 pad_string('TIME',20)+' '+pad_string('CHANNEL',16)+' MESSAGE'];
    var show_templates = ['default', 'turf_winner', 'official'];
    result.forEach(function(r) {
        if(!r['sender']['chat_name']) { return; } // non-text message
        var template = r['sender']['type'] || 'default';
        if(show_templates.indexOf(template) < 0) { return; } // non-typed message
        var sender_name = r['sender']['chat_name'];
        if('alliance_tag' in r['sender']) {
            sender_name += ' ['+r['sender']['alliance_tag']+']';
        }
        var s = pretty_print_ts(r['time']) + ' ' + pad_string(r['channel'],16) + ' ' + sender_name + ': ' + r['text'];
        lines.push(s);
    });

    display_text_blob(lines.join('\n'));
};

var method_fbpayments_get = function() {
    var ident = get_ident();
    if(ident) {
        var time_now = (new Date()).getTime()/1000;
        send_request('fbpayments', 'get', $.extend(ident, {'start_time':Math.floor(time_now - 7*86400)}), (function (ui_ident) { return function(result) {
            display_fbpayments(ui_ident, result);
        }; })(pretty_ident(ident)));
    }
};
// the server returns an array of raw JSON for payments - convert to GUI form
var display_fbpayments = function(ui_ident, result) {
    var lines = ['Recent FB Payment Transactions by '+ui_ident+' (newest at top)',
                 ''];
    result.forEach(function(r) {
        var s = pretty_print_ts(r['created_time']) + ' - Payment ID ' + r['id'] + ' - ' + r['actions'][0]['amount'] + ' ' + r['actions'][0]['currency'];
        lines.push(s);
    });

    display_text_blob(lines.join('\n'));
};

var method_clear_lockout = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#cooldown_reason")[0].value);
    if(ident && ui_reason) {
        send_request('player', 'clear_lockout', $.extend(ident, {'ui_reason':ui_reason}), function(result) { alert("Success!"); });
    }
};

var method_add_note = function() {
    var ident = get_ident();
    var body = $("#add_note_body")[0].value;
    if(ident && body.length>0) {
        send_request('player', 'add_note', $.extend(ident, {'ui_reason':body}), function(result) {
            display_response("Success!");
            $("#add_note_body").val('');
        });
    }
};

var method_send_message = function() {
    var ident = get_ident();
    var sender = $("#send_message_sender")[0].value;
    var subject = $("#send_message_subject")[0].value;
    var body = $("#send_message_body")[0].value;
    var ui_reason = check_ui_reason($("#send_message_reason")[0].value);
    if(ident && sender.length>0 && subject.length>0 && body.length>0 && ui_reason) {
        send_request('player', 'send_message', $.extend(ident, {'message_sender': sender, 'message_subject': subject, 'message_body': body, 'ui_reason':ui_reason}), function(result) { alert("Success!"); });
    }

};
var method_get_raw_player = function() {
    var ident = get_ident();
    if(ident) {
        if(0) {
            send_request('player', 'get_raw_player', $.extend(ident, {'stringify':1}), function(result) {
                var content = 'data:text/javascript,'+encodeURIComponent(result);
                window.open(content, '_blank');
            });
        } else {
            var attachment_name = ('user_id' in ident ? ident['user_id'].toString() : ('facebook_id' in ident ? 'fb'+ident['facebook_id'] : ('battlehouse_id' in ident ? 'bh'+ident['battlehouse_id'] : 'unknown'))) + '_'+spin_game_id+'.txt';
            var args = $.extend(ident, {'spin_token':spin_token, 'method':'get_raw_player', 'stringify':0, 'attachment_name':attachment_name, 'gzip_encode':1});
            window.open(spin_url+'/player?'+$.param(args), '_blank');
        }
    }
};
var method_visit_player_base = function () {
    if('visit_base_url' == '') {
        alert("Visit base URL configuration error.");
        return;
    }
    var base_id = $('#lookup_output')[0].value.split('\n')[0].replace('User ID:','').replace(/\s+/g, '');
    var visit_player_base_url = visit_base_url + base_id;
    window.open(visit_player_base_url, '_blank');
}
var method_get_all_alts = function() {
    var ident = get_ident();
    if(ident) {
        $('#per_player').hide();
        $('#lookup_output')[0].value = '';
        ident['get-all-alts'] = 'get-all-alts';
        send_request('player', 'lookup', ident, function(result) {
            $('#per_player').show();
            $('#player_tools').show();
            $('#lookup_output')[0].value = result.toString();
            $('#lookup_output').elastic("update");
        });
    }
}
var method_remove_mentor = function() {
    var ident = get_ident();
    var ui_reason = check_ui_reason($("#alliance_player_reason")[0].value);
    var args = {'ui_reason': ui_reason, 'method':'remove_mentor'}
    if(ident && ui_reason) {
        send_request('player', 'remove_mentor', $.extend(ident, args), function(result) { display_response("Success!"); });
    }
}
var method_change_player_alias = function() {
    var ident = get_ident();
    var new_alias = check_mandatory_input($("#player_updates_new_alias")[0].value, 'new callsign (name)');
    if(new_alias.length < 4 || new_alias.length > 15) {
        display_error('New callsign must be at least 4 characters and less than 15 characters');
        return;
    }
    var ui_reason = check_ui_reason($("#alliance_player_reason")[0].value);
    var args = {'ui_reason': ui_reason, 'method':'change_player_alias', 'new_alias':new_alias};
    if(ident && ui_reason) {
        send_request('player', 'change_player_alias', $.extend(ident, args), function(result) { display_response("Success!"); });
    }
}
var method_get_personal_info = function() {
    var ident = get_ident();
    if(ident) {
        var attachment_name = ('user_id' in ident ? ident['user_id'].toString() : ('facebook_id' in ident ? 'fb'+ident['facebook_id'] : ('battlehouse_id' in ident ? 'bh'+ident['battlehouse_id'] : 'unknown'))) + '_userdb.txt';
        var args = $.extend(ident, {'spin_token':spin_token, 'method':'get_personal_info', 'stringify':0, 'attachment_name':attachment_name, 'gzip_encode':1});
        window.open(spin_url+'/player?'+$.param(args), '_blank');
    }
};
var update_item_to_give_widget_state = function() {
    if($("#item_to_give_text")[0].value) {
        $("#item_to_give").attr('disabled', 'disabled');
    } else {
        $('select').removeAttr('disabled');
    }
};

// extract mongodb timestamp from a log entry "_id" field
// alternatively, could use the "time" field if present
var log_entry_time = function(entry) {
    return parseInt(entry['_id'].slice(0,8), 16);
};

// prettify timestamps for GUI
var pretty_print_ts = function(ts) {
    return (new Date(ts*1000)).toUTCString().slice(5,25);
};

// pad string with spaces
var pad_string = function(s, len) {
    var ret = s;
    while(ret.length < len) {
        ret += ' ';
    }
    return ret;
};

// return pretty HTML version of log entry
var log_ignore_re = new RegExp('Object expected|Cannot read property \'postMessage\' of null', 'g');
var log_formats = [
    // serious things that need investigation
    [(new RegExp('gamedata checksum FAIL|REFUND|DISPUTE|async write error|trusting Facebook that|object_combat_updates: user|destroy_object: user')), function(t) { return '<font color="#dd0000"><b>'+t+'</b></font>'; }],
    // warning messages
    [(new RegExp('LOGIN_ABUSE|I/O overload|IOSystem: large object')), function(t) { return '<font color="#b04000"><b>'+t+'</b></font>'; }],
    // less important messages that can usually be ignored
    [(new RegExp('bad client message|extremely long session|got stale data|but acquirer gen|attack spam|raises object HP|PING_BASE_DAMAGE|found when decoding array|squad is locked|squad moved|has foreign squad|trim_unit_space|squad_exit_map |oversize army|Setting up AI|starting up|shutdown complete|mismatched gamedata build|repair speedup time|repair queue is empty|unrecognized PortraitProxy URL|index_visit_check_scope_response|NoSQL spy error')), function(t) { return '<font color="#c0c0c0">'+t+'</font>'; }],
];
var newline_re = new RegExp('\n', 'g');
var tab_re = new RegExp('\t', 'g');
var client_exception_re = new RegExp('"location":"[^"]*"|"method":"[^"]*stack', 'g');
var client_exception_stack_keep_re = new RegExp('http.*/(.+)-CSV.*\\.js', 'g');
var client_exception_stack_remove_re = new RegExp('message.*', 'gm');
var TAB = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
var NEWLINE = '<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';

var quote_for_html = function(text) {
    return text.replace(/[<&>]/g, function(s) { return {'<':'&lt;','&':'&amp;','>':'&gt;'}[s]; });
};

var pretty_log_entry = function(e) {
    var text;
    if(e['code'] == 970) {
        // special handling for client exceptions
        $.each(['_id','time','ip','player_state','event_name','locale','code','anon_id','acquisition_ad_skynet',
                'gameclient_build_date','gamedata_build_info','browser_hardware','User-Agent','ident'], function(index, field) {
            if(field in e) { delete e[field]; }
        });

        var location = null, method = null;
        if('method' in e) {
            method = e['method'];
            delete e['method'];

            // trim to just the first few stack frames
            var trim_index = method.indexOf('message:');
            if(trim_index >= 0) {
                method = method.slice(0, trim_index);
            }
            method = method.replace(client_exception_stack_keep_re, '$1');
            method = method.replace(client_exception_stack_remove_re, '');
            method = method.trimRight();
            //method = '<font color="#000000">'+method+'</font>';
            method = quote_for_html(method);
            method = method.replace(newline_re, NEWLINE);
        }
        if('location' in e) {
            location = '<font color="#000000">'+quote_for_html(e['location'].trimRight())+'</font>';
            delete e['location'];
        }

        text = JSON.stringify(e, null, 1);
        if(location) { text = text + NEWLINE+location; }
        if(method) { text = text + NEWLINE+method; }
        //text = text.replace(new RegExp('","','g'), '",<br>"');
        text = '<font color="#c0c0c0">' + text + '</font>';
        //text = text.replace('"location":', '"<font color="#dd0000"><b>location":</b></font>');
        //text = text.replace('"method":', '"<font color="#dd0000"><b>method":</b></font>');
    } else if('text' in e) {
        text = quote_for_html(e['text'].trimRight());
        $.each(log_formats, function(index, pattern_func) {
            if(text.search(pattern_func[0]) >= 0) {
                text = pattern_func[1](text);
            }
        });
    } else {
        text = JSON.stringify(e);
    }

    if(text.search(log_ignore_re) != -1) { return null; }

    text = text.trimRight();
    text = text.replace(tab_re, TAB);
    text = text.replace(newline_re, NEWLINE);
    return text;
};

var LOGS = [{'log_name': 'log_exceptions',
             'last_id': '', // last seen ID
             'pending': false},
            {'log_name': 'log_client_exceptions',
             //'code_filter': 970,
             'last_id': '', // last seen ID
             'pending': false}];
var log_gen = 0;
var log_buf = [];
var log_interval = 10;
var log_init = false;
var log_last_time = -1; // last seen timestamp
var log_start_time = spin_log_bookmark; // start of query range
var log_end_time = -1; // end of query range
var log_timer = null;

var reset_logs = function() {
    log_gen += 1;
    if(log_timer) {
        window.clearTimeout(log_timer);
        log_timer = null;
    }

    $.each(LOGS, function(index, log_data) {
        log_data['pending'] = false;
        log_data['last_id'] = '';
    });
    log_buf = [];
    log_last_time = -1;
    log_end_time = -1;
    $('#logs_output').empty();
    $('#log_area_status')[0].innerHTML = 'Ready';
};

// reset to the beginning of today
var logs_today = function() {
    reset_logs();
    var time_now = (new Date()).getTime()/1000;
    log_start_time = 86400*(Math.floor(time_now/86400)); // beginning of UTC day
    refresh_logs();
};

// reset to the beginning of yesterday
var logs_yesterday = function() {
    reset_logs();
    var time_now = (new Date()).getTime()/1000;
    log_end_time = 86400*(Math.floor(time_now/86400)); // beginning of UTC day
    log_start_time = log_end_time - 86400;
    refresh_logs();
};

// reset to 24 hours prior to current display
var logs_rewind_one_day = function() {
    reset_logs();
    log_start_time -= 86400; // rewind log by 24 hours
    log_end_time = log_start_time + 86400;
    refresh_logs();
};

// reset to 24 hours after current display
var logs_forward_one_day = function() {
    reset_logs();
    var time_now = (new Date()).getTime()/1000;
    log_start_time += 86400; // forward log by 24 hours
    log_end_time = log_start_time + 86400;
    if(log_end_time >= time_now) {
        log_end_time = -1; // reset to default end if end time exceeds now
    }
    if(log_start_time >= time_now) { // if start time exceeds now, use today function instead
        logs_today();
        return;
    }
    refresh_logs();
};



var logs_clear = function() {
    $('#logs_output').empty();

    // go back to today, starting now
    reset_logs();
    log_start_time = (new Date()).getTime()/1000;
    $('#log_area_status')[0].innerHTML = 'Following...';
    //log_timer = window.setTimeout(refresh_logs, 1000*log_interval);
    spin_log_bookmark_dirty = true;
    refresh_logs();
};

var refresh_logs = function() {
    //console.log('refresh_logs');
    log_timer = null;
    var time_now = (new Date()).getTime()/1000;

    if(log_start_time < 0) {
        logs_today();
    }

    if(log_last_time < 0) {
        log_last_time = 0;
        $('#logs_output')[0].innerHTML = pretty_print_ts(log_start_time) + '&nbsp;--------------------<br>';
    }

    $.each(LOGS, function(junk, log_data) {

        if(log_data['pending']) {
            return;
        }

        log_data['pending'] = true;

        var method;
        var qs = {'log_name':log_data['log_name']};
        if(log_data['last_id']) {
            method = 'get_more';
            qs['start_id'] = log_data['last_id'];
        } else {
            method = 'get_by_time';
            qs['start_time'] = log_start_time.toFixed(0);
        }
        if(log_end_time > 0) { qs['end_time'] = log_end_time.toFixed(0); }
        if('code_filter' in log_data) { qs['code'] = log_data['code_filter'].toString(); }

        if(log_start_time > 0 && log_end_time < 0 && spin_log_bookmark_dirty) {
            // if actively tailing logs, update bookmark
            spin_log_bookmark_dirty = false;
            qs['bookmark'] = log_start_time.toFixed(0);
        }

        $('#log_area_status')[0].innerHTML += '.'; //+log_data['log_name'];
        send_request('logs', method, qs,
                     (function (_log_data, _log_gen) { return function(result) {
                         _log_data['pending'] = false;

                         if(_log_gen != log_gen) {
                             //console.log('aborted query on '+_log_data['log_name']);
                             return;
                         }
                         //console.log('done '+_log_data['log_name']+' at '+time_now.toFixed(0));

                         $.each(result, function(index, entry) {
                             log_buf.push(entry);
                             if(!_log_data['last_id'] || _log_data['last_id'] < entry['_id']) {
                                 _log_data['last_id'] = entry['_id'];
                             }
                         });

                         for(var i = 0; i < LOGS.length; i++) { if(LOGS[i]['pending']) { return; } }

                         $('#log_area_status')[0].innerHTML = 'Ready';

                         log_buf.sort(function(a,b) {
                             var ta = log_entry_time(a), tb = log_entry_time(b);
                             if(ta < tb) { return -1; } else if(ta > tb) { return 1; } else { return 0; }
                         });

                         var buf = '';
                         $.each(log_buf, function(index, entry) {
                             var ts = log_entry_time(entry);
                             log_last_time = Math.max(log_last_time, ts);

                             var pentry = pretty_log_entry(entry);
                             if(pentry) {
                                 var txt = pretty_print_ts(ts);
                                 if(1 && ('ident' in entry)) {
                                     txt += ' ';
                                     var ids = 12 - entry['ident'].length;
                                     txt += entry['ident'];
                                     for(var i = 0; i < ids; i++) {
                                         txt += '&nbsp;';
                                     }
                                 }
                                 txt += '&nbsp;&nbsp;';
                                 txt += pentry+'<br>';
                                 buf += txt;
                             }
                         });
                         var logs_output = $('#logs_output');
                         logs_output[0].innerHTML += buf;

                         // scroll to show latest entries if there is
                         // more than one screenfull of text, and if
                         // window is already near the very bottom
                         if(logs_output[0].scrollHeight >= logs_output.height() &&
                            logs_output[0].scrollTop + logs_output.height() - logs_output[0].scrollHeight > -200) {
                             var new_scrollTop = logs_output[0].scrollHeight - logs_output.height();
                             if(Math.abs(new_scrollTop - logs_output[0].scrollTop) >= 10) {
                                 // only scroll if the delta is substantial
                                 logs_output.scrollTop(logs_output[0].scrollHeight);
                                 //logs_output.scrollTop(logs_output[0].scrollHeight);
                             }
                         }

                         log_buf = [];
                         //console.log('done ALL at '+time_now.toFixed(0));
                         if(!log_timer && log_end_time < 0 && log_start_time > 0 && (time_now - log_start_time < 86400) && $('#mode_logs').is(":visible")) {
                             log_timer = window.setTimeout(refresh_logs, 1000*log_interval);
                             $('#log_area_status')[0].innerHTML = 'Following...';
                         }

                     }; })(log_data, log_gen), true);
    });
};

var refresh_credits = function() {
    $('#credits_status_button').prop('disabled',true);
    //$('#credits_status')[0].innerHTML = '-';
    send_request('logs', 'get_credits', {'log_name': 'log_credits'}, function (result) {
        $('#credits_status')[0].innerHTML = $.map(result, function(entry) {
            var ret = entry['date'] + ': $' + Math.floor(entry['net']).toFixed(0);
            if('proj' in entry) {
                ret += ' (24h proj $'+Math.floor(entry['proj']).toFixed(0)+')';
            }
            return ret;
        }).join('&nbsp;&nbsp;');
        $('#credits_status_button').prop('disabled',false);
    }, true);
};

var send_server_control_cmd = function(server_name, cmd, args, cb) {
    send_request('server', cmd, $.extend(args, {'server':server_name}), (function (_server_name, _cmd, _cb) { return function(result) {
        // all of these return a new status block
        result['server_name'] = _server_name;
        if(result['server_name'] in cur_server_status_rows) {
            refresh_server_status_row(cur_server_status_rows[result['server_name']], result);
        }
        if(_cb) {
            _cb();
        }
    }; })(server_name, cmd, cb), true);
};

var make_gamedata = function() {
    send_request('gamedata', 'make', {}, function(result) {
        $('#make_gamedata_result')[0].innerHTML = 'OK '+result['gamedata_build'];
    });
};
var scm_up = function() {
    send_request('scm', 'up', {}, function(result) {
        display_response(result);
    });
};
var download_art = function() {
    send_request('gamedata', 'download_art', {}, function(result) {
        display_response(result);
    });
};
var compile_client = function() {
    send_request('gameclient', 'compile', {}, function(result) {
        display_response(result);
    });
};

var setup_ai_base = function() {
    var sid_range = $("#setup_ai_base_id")[0].value;
    if(!sid_range) { return; }
    var id_list;
    if(sid_range.indexOf('-') != -1) {
        id_list = [];
        var fields = sid_range.split('-');
        for(var i = parseInt(fields[0]); i < parseInt(fields[1])+1; i+= 1) {
            id_list.push(i);
        }
    } else {
        id_list = [parseInt(sid_range)];
    }

    // filter out invalid base IDs
    id_list = $.grep(id_list, function (idnum) { return spin_ai_base_ids.indexOf(idnum) != -1; });

    console.log(id_list);
    function do_setup(id_list) {
        if(id_list.length < 1) { return; }
        send_request('server', 'setup_ai_base', {'idnum': id_list[0].toString()},
                     (function (_next_id_list) { return function(result) {
                         do_setup(_next_id_list);
                     }; })(id_list.slice(1)), false);
    }
    do_setup(id_list);
}


var game_server_port_range = [8002,8200];
var game_server_name_prefix = 'server';
var server_name_re = new RegExp(game_server_name_prefix + '([0-9]+)([A-Z]+)');

/** @param {string} name
    @return {[number, string]} generation, suffix
    return (generation, suffix) from a game server name */
var parse_server_name = function(name) {
    var groups = server_name_re.exec(name);
    if(!groups) { throw Error('bad server name '+name); }
    return [parseInt(groups[1], 10), groups[2]];
};

// convert A, B, ... AA, BB, ... server name suffix to a 1-based index
var suffix_to_num = function(s) {
    var ret = 0;
    for(var i = 0; i < s.length; i++) {
        var c = s.charCodeAt(i) - 'A'.charCodeAt(0) + 1;
        ret += Math.pow(26, s.length - 1 - i) * c;
    }
    return ret;
};
// inverse of above
var num_to_suffix = function(n) {
    var s = '';
    while(n > 0) {
        var rem = n % 26;
        if(rem === 0) {
            rem = 26;
            n -= 1;
        }
        var next = String.fromCharCode('A'.charCodeAt(0) + rem - 1);
        s = next + s;
        n = Math.floor(n/26);
    }
    return s;
};

/** Greater-than operator for server suffixes
    @param {string} a
    @param {string} b
    @return {boolean}
*/
var suffix_is_greater = function(a, b) {
    return suffix_to_num(a) > suffix_to_num(b);
};

/** @param {!Array.<Object>} to_check - array of server config JSON to check against
    @param {number} generation
    @return {string}
    return the next suffix to use for a new server of a particular generation
    (greater than any previous suffix within this generation)
    */
var next_server_suffix = function(to_check, generation) {
    var suffix = num_to_suffix(1); // start with A and advance according to conflicts detected
    for(var i = 0; i < to_check.length; i++) {
        var entry = to_check[i];
        if(entry['server_name'].indexOf(game_server_name_prefix) !== 0) { continue; } // not a game server
        var generation_suffix = parse_server_name(entry['server_name']);
        var other_generation = generation_suffix[0], other_suffix = generation_suffix[1];
        if(other_generation === generation &&
           (other_suffix === suffix || suffix_is_greater(other_suffix, suffix))) {
            // advance to next suffix after other_suffix
            suffix = num_to_suffix(suffix_to_num(other_suffix) + 1);
        }
    }
    return suffix;
};

/** @param {!Array.<Object>} to_check - array of server config JSON to check against
    @param {number} generation
    @return {number|null}
    return the next available port PAIR for a new server
    where the return value is the lower (even) number for non-SSL connections
    and the next-higher (odd) number will be used for SSL connections.
    */
var next_server_port = function(to_check) {
    var port = game_server_port_range[0];
    while(port < game_server_port_range[1]) {
        var conflict = false;
        for(var i = 0; i < to_check.length; i++) {
            var entry = to_check[i];
            var iport = entry['external_http_port'] || entry['game_http_port'];
            if(iport == port) {
                conflict = true;
                break;
            }
        }
        if(!conflict) {
            break;
        }
        port += 2;
    }
    if(port+1 > game_server_port_range[1]) {
        return null;
    }
    return port;
};

var server_start = function() {
    var generation = parseInt($("#server_start_gen")[0].value, 10);
    var qty = Math.min(Math.max(parseInt($("#server_start_qty")[0].value, 10), 1), 20);

    var configs = [];
    for(var n = 0; n < qty; n++) {

        // check suffix/port uniqueness against current servers
        // PLUS proposed list of new servers to start
        var to_check = cur_server_status.concat(configs);

        var suffix = next_server_suffix(to_check, generation);
        var port = next_server_port(to_check);

        if(port === null) { display_error('no ports available'); return; }

        var server_name = game_server_name_prefix+generation.toString()+suffix;
        var config = {'server_name':server_name,
                      'game_http_port':port, 'game_ssl_port': (spin_ssl_available ? port+1 : -1),
                      'game_ws_port': port, 'game_wss_port': (spin_ssl_available && spin_wss_available ? port+1 : -1)};
        configs.push(config);
    }
    console.log(configs);
    function do_launch(config_list) {
        if(config_list.length < 1) { return; }
        var launch_config = $.extend({}, config_list[0]);
        var server_name = launch_config['server_name']; delete launch_config['server_name'];
        launch_config['start_state'] = 'closed';
        send_request('server', 'start', {'server':server_name, 'config':JSON.stringify(launch_config)},
                     (function (_next_config_list) { return function(result) {
                         refresh_server_status();
                         do_launch(_next_config_list);
                     }; })(config_list.slice(1)), false);
    }
    do_launch(configs);
};

var cur_server_status = []; // updated from refresh_server_status
var cur_server_status_rows = {};

// build dates being used by proxyserver - used to determine which servers are "live"/exposed to players
var cur_proxy_builds = {'gameclient_build':null, 'gamedata_build':null};

var server_status_pending = false, server_latency_pending = false;
var server_status_interval = 15;

var server_status_fields = [{'name':'server_name','type':'server_name'},
                            {'name':'state','type':'state'},
                            {'name':'ssn','var':'active_sessions','type':'active_sessions'},
                            {'name':'$ssn','var':'paying_sessions','type':'int'},
                            //{'name':'clients','var':'active_protocol_clients','type':'int'},
                            //{'name':'requests','var':'active_protocol_requests','type':'int'},
                            {'name':'load','var':'load_unhalted','type':'load'},
                            {'name':'memfree','var':'machine_stats:machine_mem_free_mb','type':'memory_free'},
                            {'name':'diskfree','var':'machine_stats','type':'disk_free'},
                            {'name':'branch','var':'scm_branch','type':'text'},
                            {'name':'gameclient_build','type':'build'},
                            {'name':'gamedata_build','type':'build'}
                           ];

var refresh_server_status_row = function(row, item) {
    row.empty();
    $.each(server_status_fields, function(index, field) {
        var val = null;
        var path = (field['var'] || field['name']).split(':');
        for(var p = item, i = 0; i < path.length; i++) {
            if(path[i] in p) {
                if(i == path.length-1) {
                    val = p[path[i]];
                    break;
                } else {
                    p = p[path[i]];
                }
            } else {
                break;
            }
        }
        var s = '';
        if(val !== null) {
            if(field['type'] == 'text') {
                s = val;
            } else if(field['type'] == 'int') {
                s = val.toFixed(0);
            } else if(field['type'] == 'pct') {
                s = (100*val).toFixed(0)+'%';
            } else if(field['type'] == 'load') {
                if(val < 0) {
                    s = '';
                } else {
                    s = (100*val).toFixed(0)+'%';
                    if(val > 0.3) {
                        s = '<font color="#ff0000">'+s+'</font>';
                    }
                }
            } else if(field['type'] == 'state') {
                s = val;
                if(val != 'ok') {
                    s = '<font color="#c00000">'+s+'</font>';
                }
            } else if(field['type'] == 'memory_free') {
                s = val.toFixed(0)+' MB';
                if(val < 2000) { // warn below 2GB
                    s = '<font color="#ff0000">'+s+'</font>';
                }
            } else if(field['type'] == 'disk_free') {
                // free space on disk with least free space
                var min_free = 999.0;
                var min_disk_name = '-';
                var reg = /disk_space_free_gb \((.+)\)/;
                for(var key in val) {
                    if(key.indexOf('disk_space_free_gb') === 0) {
                        var disk_name = reg.exec(key)[1];
                        if(!disk_name) { continue; }
                        if(disk_name.indexOf('/dev') === 0) { continue; }
                        // skip root, unless almost full
                        if(disk_name === '/' && val[key] >= 1.0) { continue; }
                        if(val[key] < min_free) {
                            min_free = val[key];
                            min_disk_name = disk_name;
                        }
                    }
                }
                s = min_free.toFixed(1)+' GB';
                if(min_free < 2.0) { // warn below 2GB
                    s = '<font color="#ff0000">'+s+' ('+min_disk_name+')'+'</font>';
                }
            } else if(field['type'] == 'active_sessions') {
                s = val.toFixed(0);
                var has_regions = Object.keys(spin_regions).length > 0;
                var warn_if_over = (has_regions ? 100 : 300);
                var has_stuck_sessions = (item['stuck_sessions']||0) > 0;
                if(item['type'] !== 'proxyserver' &&
                   (val >= warn_if_over || has_stuck_sessions)) {
                    s = '<font color="#ff0000">'+s+'</font>';
                }
            } else if(field['type'] == 'server_name') {
                s = val;
                var url = null;
                if('game_ssl_port' in item && item['game_ssl_port'] > 0) {
                    if(spin_direct_multiplex) {
                        url = spin_url.replace('PCHECK','ADMIN')+'?spin_game_server_port='+item['game_ssl_port'].toString();
                    } else {
                        url = 'https://'+item['hostname']+':'+item['game_ssl_port'].toString()+'/ADMIN';
                    }
                } else if('game_http_port' in item && item['game_http_port'] > 0) {
                    url = 'http://'+item['hostname']+':'+item['game_http_port'].toString()+'/ADMIN';
                }
                if(url) { s = '<a href="'+url+'" target="_blank">'+s+'</a>'; }

                if(cur_proxy_builds['gameclient_build']) {
                    if(item['gameclient_build'] != cur_proxy_builds['gameclient_build'] || item['gamedata_build'] != cur_proxy_builds['gamedata_build']) {
                        s += ' <font color="#c00000">mismatch</font>';
                    }
                }

                var server_name = val;

                if(spin_token_data['roles'].indexOf('ADMIN') != -1) {
                    var btn_list = [{'name':'reconfig','ui_name':'HUP'},
                                    {'name':'maint_kick','ui_name':'maint'},
                                    {'name':'change_state','args':{'state':'ok'},'ui_name':'open'},
                                    {'name':'change_state','args':{'state':'closed'},'ui_name':'close'},
                                    {'name':'shutdown','ui_name':'stop'}];
                    if(item['state'] == 'maint_kick') {
                        btn_list.push({'name':'panic_kick','ui_name':'panic'});
                    }
                    $.each(btn_list,
                           function(index, btn) {
                               var btn_id = 'server_'+server_name+'_btn_'+index.toString()+btn['name'];
                               var args = btn['args'] || {};
                               var onclick = "$('#"+btn_id+"').attr('disabled','disabled'); send_server_control_cmd('"+val+"','"+btn['name']+"',"+JSON.stringify(args).replace(new RegExp('"','g'), "'")+", function() { $('#"+btn_id+"').removeAttr('disabled'); });";
                               s += ' <button id="'+btn_id+'" onclick="'+onclick+'" class="spin_button_tiny">'+btn['ui_name']+'</button>';
                           });
                }

            } else if(field['type'] == 'build') {
                // usually these can be passed directly to Date() constructor
                var val_date;
                try {
                    val_date = new Date(val);
                    s = val_date.toUTCString().slice(5,25);
                } catch (e) {
                    s = '???';
                }
                if(cur_proxy_builds['gameclient_build']) {
                    if(item['gameclient_build'] != cur_proxy_builds['gameclient_build'] || item['gamedata_build'] != cur_proxy_builds['gamedata_build']) {
                        s = '<font color="#c00000">'+s+'</font>';
                    } else {
                        s = '<font color="#008000">'+s+'</font>';
                    }
                }
            }
        }
        var s_div = $('<div>', {html: s}).addClass('spin_server_status_td_div');
        var cell = $('<td>').addClass('spin_server_status_td');
        if(field['type'] == 'server_name') {
            cell.addClass('spin_td_nowrap');
        }
        cell.append(s_div);
        row.append(cell);
    });
};

var continue_server_status = function() {
    if(!server_status_pending && !server_latency_pending && $('#mode_server').is(":visible")) {
        window.setTimeout(function() {
            if($("#auto_refresh_server_status")[0].checked) {
                refresh_server_status();
            }
        }, 1000*server_status_interval);
    }
};

var refresh_server_status = function() {
    if(!server_status_pending) {
        server_status_pending = true;
        $('#server_status_loading')[0].innerHTML = 'Loading...';
        send_request('server', 'get_status', {}, function(result) {
            server_status_pending = false;
            cur_server_status = result;
            cur_server_status_rows = {};

            $('#server_status_loading')[0].innerHTML = 'Ready';
            $('#server_status_table').empty();


            $.each(result, function(index, item) {
                if(item['type'] == 'proxyserver' && item['state'] == 'ok') {
                    cur_proxy_builds['gameclient_build'] = item['gameclient_build'];
                    cur_proxy_builds['gamedata_build'] = item['gamedata_build'];
                }
            });

            var header_row = $('<tr>');
            $.each(server_status_fields, function(index, field) {
                var ls = field['name'].split(':');
                var s = ls[ls.length-1];
                header_row.append($('<td>', {html:'<b>'+s+'</b>'}));
            });
            $('#server_status_table').append(header_row);

            result.sort(function(a,b) {
                var aproxy = a['server_name'].indexOf('proxy') == 0, bproxy = b['server_name'].indexOf('proxy') == 0;
                if(aproxy && !bproxy) {
                    return -1;
                } else if(!aproxy && bproxy) {
                    return 1;
                } else if(a['server_name'] < b['server_name']) {
                    return -1;
                } else if(a['server_name'] > b['server_name']) {
                    return 1;
                } else {
                    return 0;
                }
            });

            $.each(result, function(index, item) {
                var row = $('<tr>');
                cur_server_status_rows[item['server_name']] = row;
                refresh_server_status_row(row, item);
                $('#server_status_table').append(row);
            });
            continue_server_status();
        }, true);
    }

    if(!server_latency_pending) {
        server_latency_pending = true;
        send_request('server', 'get_latency', {}, function(result) {
            server_latency_pending = false;
            $("#server_graph_area").empty();
            //console.log("LATENCY RESULT"); console.log(result);
            if(result['graphs'].length > 0) {
                for(var graph_id = 0; graph_id < result['graphs'].length; graph_id++) {
                    if('ui_name' in result['graphs'][graph_id]) { $("#server_graph_area").append('<p>'+result['graphs'][graph_id]['ui_name']); }
                    $("#server_graph_area").append('<p><div id="server_graph'+graph_id.toString()+'" style="width:800px; height:128px;">');
                    $.plot("#server_graph"+graph_id.toString(), result['graphs'][graph_id]['series'],
                          $.extend(result['graphs'][graph_id]['plot_params'],
                                   {'grid': {'hoverable':true}, 'zoom': {'interactive':true, 'frameRate':30}, 'pan': {'interactive':true, 'frameRate':30}}
                                  ));
                    $("#server_graph"+graph_id.toString()).bind("plothover", function (event, pos, item) {
                        if(item) {
                            //console.log(item);
                            var tip;
                            if(item.series.tooltips) {
                                tip = item.series.tooltips[item.dataIndex];
                            } else {
                                var ts = new Date(item.datapoint[0]);
                                //var x = (ts.getUTCMonth()+1).toString()+'/'+ts.getUTCDate().toString()+' '+ts.getUTCHours()+':'+ts.getUTCMinutes();//item.datapoint[0].toFixed(2);
                                var x = ts.toUTCString();
                                var y = item.datapoint[1].toFixed((item.datapoint[1] >= 1000 ? 0 : 2));
                                tip = x + ' ' + item.series.label +': ' + y;
                            }
                            $("#graph_tooltip").html(tip).css({top: item.pageY+5, left: item.pageX+5}).fadeIn(30);
                        } else {
                            $("#graph_tooltip").hide();
                        }
                    });
                }
            }
            continue_server_status();
        }, true);
    }
};

var chat_pending = false;
var cur_chat_reports = [];
var cur_chat_report_rows = {};

var refresh_chat = function() {
    if(!chat_pending) {
        $('#chat_table').empty();
        chat_pending = true;
        $('#chat_show_automated').attr('disabled', true);
        $('#chat_show_tier34').attr('disabled', true);
        $('#chat_status_loading')[0].innerHTML = 'Loading...';
        var time_now = (new Date()).getTime()/1000;
        var filter = 'unresolved';
        if($("#chat_show_automated")[0].checked) {
            filter += ',automated';
        }
        if(! $("#chat_show_tier34")[0].checked) {
            filter += ',tier12';
        }
        var violation_limit = 'none'
        if($("#chat_show_one_year_violations")[0].checked) {
            violation_limit = 'year';
        }
        send_request('chat', 'get_reports', {'start_time':time_now - 2*86400, 'end_time':time_now, 'filter': filter, 'violation_limit':violation_limit}, function(result) {
            chat_pending = false;
            $('#chat_show_automated').removeAttr('disabled');
            $('#chat_show_tier34').removeAttr('disabled');
            cur_chat_reports = result;
            cur_chat_report_rows = {};
            var time_now = (new Date()).getTime()/1000;

            $('#chat_status_loading')[0].innerHTML = (result.length > 0 ? 'Unresolved chat reports from the last 48 hours:' : 'There are no unresolved chat reports in the last 48 hours.');

            // show most recent at top
            result.sort(function (a, b) {
                if(a['time'] > b['time']) {
                    return -1;
                } else if(a['time'] < b['time']) {
                    return 1;
                } else if(a['id'] > b['id']) {
                    return -1;
                } else {
                    return 1;
                }
            });
            $.each(result, function(index, item) {
                var row = $('<tr>');
                refresh_chat_report_row(row, item, time_now);
                cur_chat_report_rows[item['id']] = row;
                $('#chat_table').append(row);
            });
        }, true);
    }
};

// detect '*** ... ***' added by server and replace with boldface
var prettify_context = function(sender_ui_name, text) {
    var lines = text.split('\n');
    for(var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var hit = null;
        if(line.indexOf('*** ') == 0 && line.slice(line.length-4, line.length) == ' ***') {
            hit = line.slice(4, line.length-4);
        }
        line = sender_ui_name+': '+(hit ? hit : line);
        if(hit) {
            line = '<b>'+line+'</b>';
        }
        lines[i] = line;
    }
    return lines.join('\n');
};

var refresh_chat_report_row = function(row, item, time_now) {
    row.empty();
    var target_ui_name = (item['target_ui_name'] || 'unknown');
    var reporter_ui_name;
    console.log(item);
    if(item['source'] === 'ml') {
        reporter_ui_name = '<i>ChatMom ML model (confidence <b>%conf</b>)</i>'.replace('%conf', item['confidence'].toFixed(3));
    } else if(item['source'] === 'rule') {
        reporter_ui_name = '<i>ChatFilter rule</i>';
    } else {
        reporter_ui_name = 'player %reporter_id <b>%ui_name</b>'.replace('%reporter_id', item['reporter_id'].toString()).replace('%ui_name', item['reporter_ui_name'] || 'unknown');
    }
    var s = '%abstime (%relhoursh ago), player %target_id <b>%target_ui_name</b> (%target_receipts Receipts, %warnings_header%target_warnings Warnings%warnings_footer, %violations_header%target_violations Violations%violations_footer) said in channel <tt>%channel</tt>:<br><pre>%context</pre>and was reported by %reporter_ui_name at %report_time';
    s = s.replace('%abstime', pretty_print_ts(item['time']));
    s = s.replace('%relhours', ((time_now - item['time'])/3600.0).toFixed(1));
    s = s.replace('%target_id', item['target_id'].toString());
    s = s.replace('%target_receipts', item['target_receipts'].toString());
    s = s.replace('%target_warnings', item['target_warnings'].toString());
    if(parseInt(item['target_warnings']) >= 20) {
        s = s.replace('%warnings_header','<span style="font-weight: bold;color:red">');
        s = s.replace('%warnings_footer','</span>');
    } else {
        s = s.replace('%warnings_header','');
        s = s.replace('%warnings_footer','');
    }
    s = s.replace('%target_violations', item['target_violations'].toString());
    if(parseInt(item['target_violations']) >= 20) {
        s = s.replace('%violations_header','<span style="font-weight: bold;color:red">');
        s = s.replace('%violations_footer','</span>');
    } else {
        s = s.replace('%violations_header','');
        s = s.replace('%violations_footer','');
    }
    s = s.replace('%reporter_id', item['reporter_id'].toString());
    s = s.replace('%target_ui_name', target_ui_name);
    s = s.replace('%reporter_ui_name', reporter_ui_name);
    s = s.replace('%channel', item['channel']);
    s = s.replace('%context', prettify_context(target_ui_name, $.trim(item['context'])));
    s = s.replace('%report_time', pretty_print_ts(item['report_time']));

    var text_div = $('<div>', {html: s}).css("float","left");

    var button_div = $('<div>').css("float","right");
    var btn_list = [];
    if($GOOGLE_TRANSLATE_ENABLED$) {
        btn_list.push({'action':'translate','ui_name': 'Translate','color':'#ffffd0'});
    }
    btn_list.push({'action':'ignore','ui_name':'Ignore','color':'#d0d0d0'});
    btn_list.push({'action':'warn','ui_name':'Send Warning','color':'#d0d000'});
    btn_list.push({'action':'violate','ui_name':'Add Offense','color':'#ff8080'});
    $.each(btn_list,
           function(index, btn) {
               var button = $('<button>', {html: btn['ui_name']}).addClass('spin_button');
               button.css("background-color", btn['color']);
               button.css("width", "110px");
               button.click((function (_row, _item, _action) { return function() {
                   if(_action === 'translate') {
                       translate_chat_report(_item);
                   } else {
                       resolve_chat_report(_row, _item, _action);
                   }
               }; })(row, item, btn['action']));
               button_div.append(button);
           });

    var cell = $('<td>').addClass('spin_chat_report_td');
    cell.append(text_div);
    cell.append(button_div);

    row.append(cell);
};

var translate_chat_report = function(item) {
    send_request('chat', 'translate', {'text': item['context'], 'to_language': 'en'}, (function(_item) { return function(result) {
        display_response("Google Translate says this is language <b>%source_language</b> and means:<p>%translation".replace('%source_language', ('source_language' in result ? result['source_language'] : 'unknown')).replace('%translation',result['translation']));
    }; })(item));
};

var resolve_chat_report = function(row, item, action) {
    var async = (action === 'ignore');
    send_request('chat', 'resolve_report', {'id': item['id'], 'user_id': item['target_id'], 'action': action},
                 (function (_row, _item, _action) {
                     return function(result) {
                         row.empty();
                         cur_chat_reports = cur_chat_reports.filter(function(other) { return other['id'] !== _item['id']; });

                         if(_action !== 'ignore') {
                             display_response("Success!\n"+result.toString());

                             // clear unresolved reports that refer to things said before this violation
                             cur_chat_reports = cur_chat_reports.filter(function(other) {
                                 if(other['target_id'] == item['target_id'] && other['id'] in cur_chat_report_rows) {
                                     cur_chat_report_rows[other['id']].empty();
                                     delete cur_chat_report_rows[other['id']];
                                     return false;
                                 }
                                 return true;
                             });
                         }

                         if(cur_chat_reports.length == 0) {
                             $('#chat_status_loading')[0].innerHTML = 'There are no more unresolved chat reports in the last 48 hours.';
                         }

                     }; })(row, item, action), async);
    if(async) {
        row.empty();
    }
};

var refresh_clock = function() {
    var text = (new Date()).toUTCString().slice(0,22)+' UTC.';
    text += ' Logged in as <b>$SPIN_USERNAME$</b>.';
    $('#clock')[0].innerHTML = text;
    window.setTimeout(refresh_clock, 10*1000);
};

// see http://stackoverflow.com/questions/14859281/select-tab-by-name-in-jquery-ui-1-10-0
$.fn.tabIndex = function () {
    return $(this).parent().find(this).index();
};
$.fn.selectTabByID = function (tabID) {
    $(this).tabs("option", "active", $('#' + tabID).tabIndex());
};

$(function() {
    // hide server controls if ADMIN role is missing
    if(spin_token_data['roles'].indexOf('ADMIN') == -1) {
       $('#mode_server_tab').remove();
       $('#mode_server').remove();
       //$('#mode_logs_tab').remove(); Logs now viewable by all as of 2022-01-01
       //$('#mode_logs').remove();
    } else {
       $('#server_status').bind('show', function() { console.log("HERE"); });
    }

    // whenever server mode is made active, send a status query
    var on_mode_activate = function(panel) {
        if(panel.is('#mode_server')) {
            refresh_server_status();
        } else if(panel.is('#mode_logs')) {
            refresh_logs();
            if(spin_token_data['roles'].indexOf('SKYNET') != -1) {
                refresh_credits();
            }
        } else if(panel.is('#mode_chat')) {
            refresh_chat();
        }
    };

    $('#modes').tabs({
        activate: function(event, ui) { on_mode_activate(ui.newPanel); },
        create: function(event, ui) { on_mode_activate(ui.panel); }
    });

    if(spin_token_data['roles'].indexOf('PCHECK-BAN') == -1) {
        // no ban or developer flag permission
        $('#player_tools_ban').remove();
        $('#player_tools_ban_header').remove();
    }

    if(spin_token_data['roles'].indexOf('PCHECK-WRITE') == -1) {
        // no write permission
        $('#mode_payment_tab').remove();
        $('#mode_payment').remove();
        $('#player_tools_developer').remove();
        $('#player_tools_developer_header').remove();
        $('#player_tools_give_item_gamebucks_score').remove();
        $('#player_tools_give_item_gamebucks_score_header').remove();
        $('#player_tools_send_message').remove();
        $('#player_tools_send_message_header').remove();
        $('#player_tools_clear_cooldown').remove();
        $('#player_tools_clear_cooldown_header').remove();
        $('#player_tools_change_region').remove();
        $('#player_tools_change_region_header').remove();
        $('#player_tools_alliance').remove();
        $('#player_tools_alliance_player_header').remove();
        $('#player_tools_privacy').remove();
        $('#player_tools_privacy_header').remove();
    }

    if(spin_token_data['roles'].indexOf('ADMIN') == -1) {
        // no admin permission
        $('#scm_up_button').remove();
        $('#download_art_button').remove();
        $('#make_gamedata_button').remove();
        $('#server_start_gen').remove();
        $('#server_start_qty').remove();
        $('#server_start_button').remove();
        $('#setup_ai_base_id').remove();
        $('#setup_ai_base_button').remove();
    }


    if(spin_token_data['roles'].indexOf('SKYNET') == -1) {
        // no skynet permission, no credits display
       $('#credits_status_area').remove();
    }

    $('#player_lookup').tabs();
    $('#user_id').spinner({min:0, step:1});

    // Pressing Enter while focused on a "Find by..." field should trigger the user lookup
    ['#user_id','#facebook_id','#battlehouse_id'].forEach(function (id) {
        $(id).keyup(function(event) {
            if(event.keyCode === 13) {
                method_lookup();
            }
        });
    });

    $('#player_tools').tabs();
    $('#lookup_output').elastic();
    $('#send_message_body').elastic();
    $('#chat_gag_duration').spinner({max:240, min:1, step:1});
    $('#chat_block_other_id').spinner({min:0, step:1});
    $('#ignore_alt_other_id').spinner({min:0, step:1});
    $('#migrate_account_other_id').spinner({min:0, step:1});
    $('#clear_alias_duration').spinner({max:999999, min:0, step:1});
    if(has_anti_alt_regions()) {
        $('#region_alt_banish_duration').spinner({max:999999, min:1, step:1});
    } else {
        $('#change_region_alt_banishment_controls').remove();
    }
    if(has_anti_vpn_regions()) {
        $('#region_vpn_banish_duration').spinner({max:999999, min:1, step:1});
    } else {
        $('#change_region_vpn_banishment_controls').remove();
    }
    if(has_anti_refresh_regions()) {
        $('#region_refresh_banish_duration').spinner({max:999999, min:1, step:1});
    } else {
        $('#change_region_refresh_banishment_controls').remove();
    }

    $('#gamebucks_amount').spinner({max:50000, min:0, step:100});
    $('#pvp_score_amount').spinner({max:500, min:0, step:1});
    $('#item_to_give_qty').spinner({max:50, min:1, step:1});
    $('#item_to_give_level').spinner({max:100, min:1, step:1});
    spin_giveable_items.forEach(function(entry) {
        $('#item_to_give').append('<option value="'+entry['name']+'">'+entry['ui_name']+'</option>');
    });
    if(has_non_anti_alt_regions()) {
        spin_regions.forEach(function(entry) {
            var ui_name = entry['ui_name'] + ' ('+entry['ui_description_short']+')';
            $('#change_region_destination').append('<option value="'+entry['name']+'">'+ui_name+'</option>');
        });
    } else {
            $('#change_region_destination').append('<option value="LIMBO">Banish from all maps</option>');
    }

    // with ADMIN permission, default to server status page
    if(spin_token_data['roles'].indexOf('ADMIN') != -1) {
        $('#modes').selectTabByID('mode_server_tab');
    }

    refresh_clock();
});
</script>

</head><body>

<div id="header" style="width:100%;height:50px">
<div style="float:right;"><img src="$GAME_LOGO_URL$" width="50" height="50"></div>
<div style="float:left;"><img src="$SPIN_PUBLIC_S3_URL$/battlehouse_logo_black_vector.svg" width="256" height="43"></div>
<center>
<div style="width:33%;line-height:18px;">
  <div id="clock" style="float:left;"></div>
  <button style="float:right;" onclick="delete_cookie(); var location_href_is_not='https://accounts.google.com/o/oauth2/revoke?token=$GOOGLE_ACCESS_TOKEN$'; location.href='//www.google.com/';">Log out</button>
</div>
</center>
</div>
<hr>

<div id="modes">
   <ul>
    <li><a href="#mode_player">Player</a></li>
    <li id="mode_payment_tab"><a href="#mode_payment">FB Payment</a></li>
    <li id="mode_chat_tab"><a href="#mode_chat">Chat Moderation</a></li>
    <li id="mode_server_tab"><a href="#mode_server">Server</a></li>
    <li id="mode_logs_tab"><a href="#mode_logs">Logs</a></li>
   </ul>

<div id="mode_player">

<div id="player_lookup">
  <ul>
    <li><a href="#player_lookup_by_user_id">Find by User ID</a></li>
    <li><a href="#player_lookup_by_facebook_id">Find by Facebook ID</a></li>
    <li><a href="#player_lookup_by_battlehouse_id">Find by Battlehouse ID</a></li>
  </ul>
    <div id="player_lookup_by_user_id">
        User ID: <input type="text" id="user_id" name="user_id" autofocus><button onclick="method_lookup()" class="spin_button">Lookup</button>
    </div>
    <div id="player_lookup_by_facebook_id">
        Facebook ID: <input type="text" id="facebook_id" name="facebook_id"><button onclick="method_lookup()" class="spin_button">Lookup</button>
    </div>
    <div id="player_lookup_by_battlehouse_id">
        Battlehouse ID: <input type="text" id="battlehouse_id" name="battlehouse_id"><button onclick="method_lookup()" class="spin_button">Lookup</button>
    </div>
</div>

<hr>

<div id="per_player" style="position:relative;display:none;">

<div style="position:absolute;top:5px;right:5px;"><button onclick="method_get_raw_player()" style="width:200px;height:30px;">Get PlayerDB File</button></div>
<div style="position:absolute;top:40px;right:5px;"><button onclick="method_visit_player_base()" style="width:200px;height:30px;">Visit Player Base</button></div>
<div style="position:absolute;top:75px;right:5px;"><button onclick="method_get_all_alts()" style="width:200px;height:30px;">Get All Alts</button></div>
<textarea id="lookup_output" readonly style="width:100%;height:10%;border-style:inset;border-width:2px;font-family:monospace;font-size:11px;"></textarea>

<hr>
<div id="player_tools" style="display:none;">
  <ul>
    <li><a href="#player_tools_add_note" id="player_tools_add_note_header">Add Note</a></li>
    <li><a href="#player_tools_give_item_gamebucks_score" id="player_tools_give_item_gamebucks_score_header">Give Item/$GAMEBUCKS_NAME$/Score</a></li>
    <li><a href="#player_tools_chat_gag" id="player_tools_chat_gag_header">Chat Tools/Abuse</a></li>
    <li><a href="#player_tools_send_message" id="player_tools_send_message_header">Send Message</a></li>
    <li><a href="#player_tools_clear_cooldown" id="player_tools_clear_cooldown_header">Cooldowns</a></li>
    <li><a href="#player_tools_alts_vpn_migrate" id="player_tools_alts_vpn_migrate_header">Alts/VPN/Migrate</a></li>
    <li><a href="#player_tools_change_region" id="player_tools_change_region_header">Map Region</a></li>
    <li><a href="#player_tools_alliance_player" id="player_tools_alliance_player_header">Player/Clan</a></li>
    <li><a href="#player_tools_privacy" id="player_tools_privacy_header">Privacy</a></li>
    <li><a href="#player_tools_ban" id="player_tools_ban_header">Ban</a></li>
    <li><a href="#player_tools_patron" id="player_tools_patron_header">Patron</a></li>
    <li><a href="#player_tools_developer" id="player_tools_developer_header">Developer</a></li>
  </ul>
    <div id="player_tools_add_note">
      Add an internal note to this account:
      <br>
      <textarea id="add_note_body" name="add_note_body" value="" style="width:600px;height:100px"></textarea>
      <p>
      <button onclick="method_add_note()" class="spin_button" style="width:200px;">Add Note</button><p>
    </div>
    <div id="player_tools_chat_gag">
        <p>
            <button onclick="method_chat_get()" class="spin_button" style="width:200px;">Get Recent Messages</button> Include Up To <input type="text" id="chat_message_count" name="chat_message_count" value="1000"> messages
        </p>
        <p>
            <button onclick="method_chat_ungag()" class="spin_button">Unmute</button>
            Duration: <input type="text" id="chat_gag_duration" name="chat_gag_duration" value="12"> Hours
            <button onclick="method_chat_gag($('#chat_gag_duration').spinner('value')*3600)" class="spin_button">Mute (Temporary)</button>
            <button onclick="method_chat_gag(-1)" class="spin_button">Mute (Permanent)</button>
            <br>
            <input id="chat_gag_ungag_include_alts" type="checkbox" style="height:initial;"></input>Also mute/unmute all alts (will not affect ignored alts)
            <br>
            <input id="chat_gag_ungag_include_alts_recursive" type="checkbox" style="height:initial;"></input>Recursively include alts of alts.
            <br>
            <input id="chat_gag_ungag_aggressive_alt_identification" type="checkbox" style="height:initial;"></input>Aggressively identify alts (check to include alts that last logged in 90+ days ago)
        </p>
        <p>
            Other Player ID: <input type="text" id="chat_block_other_id" name="chat_block_other_id">
            <button onclick="method_chat_block($('#chat_block_other_id').spinner('value'))" class="spin_button" style="width:200px;">Block Communication</button>
            <button onclick="method_chat_unblock($('#chat_block_other_id').spinner('value'))" class="spin_button" style="width:200px;">Unblock Communication</button>
        </p>
        <p>
            <button onclick="method_clear_alias($('#clear_alias_duration').spinner('value')*3600)" class="spin_button" style="width:300px;">Remove Alias (Call Sign/Nickname)</button>
            Cooldown until new Alias: <input type="text" id="clear_alias_duration" name="clear_alias_duration" value="12"> Hours
            <button onclick="method_remove_aura('alias_gagged')" class="spin_button" style="width:180px;">Undo Alias Cooldown</button>
        </p>
        <p>
            <button onclick="method_chat_abuse_violate()" class="spin_button" style="width:250px;">Add Offense</button>
            <button onclick="method_chat_abuse_clear()" class="spin_button" style="width:300px;">Unmute and Remove 1 Offense</button>
            Tell the player what they are being muted for:
            <br>
            <input type="text" id="chat_abuse_player_reason" style="width:500px;">
        </p>
        <p>
            Reason for this action:
            <br>
            <input type="text" id="chat_reason" style="width:500px;">
        </p>
    </div>
    <div id="player_tools_give_item_gamebucks_score">
        Pick an item from the list:
        <br>
        <select id="item_to_give" name="item_to_give" class="spin_select"></select>
        <br><br>
        Or type the internal item name (from items.json) below:
        <br>
        <input type="text" id="item_to_give_text" onkeyup="update_item_to_give_widget_state()" style="width:250px;">
        <br><br>
        Quantity: <input type="text" id="item_to_give_qty" name="item_to_give_qty" value="1" style="width:80px;">
        Level: <input type="text" id="item_to_give_level" name="item_to_give_level" value="1" style="width:80px;">
        <button onclick="method_give_item()" class="spin_button">Give</button>
        <br><br><hr><br>
        $GAMEBUCKS_NAME$ amount: <input type="text" id="gamebucks_amount" name="gamebucks_amount" value="100">
        <button onclick="method_give_gamebucks()" class="spin_button">Give</button> <button onclick="method_fbpayments_get()" class="spin_button" style="width:200px;">List Recent FB Payments</button>
        <br><br><hr><br>
        Modify PvP score: <input type="text" id="pvp_score_amount" name="pvp_score_amount" value="1">
        <button onclick="method_set_pvp_score()" class="spin_button">Set Score</button> <button onclick="method_add_pvp_score()" class="spin_button">Add Score</button>
        <p>
            Reason for this action:
            <br>
            <input type="text" id="give_item_gamebucks_score_reason" style="width:500px;">
        </p>
    </div>
    <div id="player_tools_send_message">
<table cellpadding="5">
<tr><td>From:</td><td><input type="text" id="send_message_sender" name="send_message_sender" value="Customer Support" style="width:200px"></td></tr>
<tr><td>Subject:</td><td><input type="text" id="send_message_subject" name="send_message_subject" value="Support Issue" style="width:200px"></td></tr>
<tr><td>Body:</td><td><textarea id="send_message_body" name="send_message_body" value="" style="width:600px;height:100px"></textarea></td></tr>
<tr><td><button onclick="method_send_message()" class="spin_button">Send</button></td></tr>
</table>
      <p>
      Reason for this action:
      <br>
      <input type="text" id="send_message_reason" style="width:500px;">
    </div>

    <div id="player_tools_clear_cooldown">
      <button onclick="method_clear_lockout()" class="spin_button">Clear 48h Lockout</button>
    &nbsp;&nbsp;&nbsp;&nbsp;
      Cooldown Name: <input type="text" id="cooldown_name" name="cooldown_name" value="alliance_deserter">
      <button onclick="method_clear_cooldown()" class="spin_button">Clear</button>
      <p>
      <button onclick="method_check_idle()" class="spin_button">Send Anti-Bot CAPTCHA</button>
      <p>
      Reason for this action:
      <br>
      <input type="text" id="cooldown_reason" style="width:500px;">
    </div>

    <div id="player_tools_change_region">
        <p>
            <button onclick="method_change_region_imprison()" class="spin_button">Imprison Player</button>
            <br>
            <button onclick="method_remove_aura('region_banished', {'tag': 'imprisoned'})" class="spin_button" style="width:260px;">Undo Prison Banishment</button>
        </p>
        <p>
            Force player to move to region:
            <br><br>
            <select id="change_region_destination" name="change_region_destination" class="spin_select"></select>
            <button onclick="method_change_region()" class="spin_button">Apply</button>
            <span id="change_region_alt_banishment_controls">
                <p>
                    <input id="change_region_do_alt_banish" type="checkbox" style="height:initial;"></input>Also banish from anti-alt regions for:
                    <input type="text" id="region_alt_banish_duration" name="region_alt_banish_duration" value="720" style="width:100px"> Hours
                    <button onclick="method_remove_aura('region_banished', {'tag': 'anti_alt'})" class="spin_button" style="width:260px;">Undo Anti-Alt Banishment</button>
                </p>
            </span>
            <span id="change_region_vpn_banishment_controls">
                <p>
                    <input id="change_region_do_vpn_banish" type="checkbox" style="height:initial;"></input>Also banish from anti-VPN regions for:
                    <input type="text" id="region_vpn_banish_duration" name="region_vpn_banish_duration" value="720" style="width:100px"> Hours
                    <button onclick="method_remove_aura('region_banished', {'tag': 'anti_vpn'})" class="spin_button" style="width:260px;">Undo Anti-VPN Banishment</button>
                </p>
            </span>

            <span id="change_region_refresh_banishment_controls">
                <p>
                    <input id="change_region_do_refresh_banish" type="checkbox" style="height:initial;"></input>Also banish from anti-refresh regions for:
                    <input type="text" id="region_refresh_banish_duration" name="region_refresh_banish_duration" value="720" style="width:100px"> Hours
                    <button onclick="method_remove_aura('region_banished', {'tag': 'anti_refresh'})" class="spin_button" style="width:260px;">Undo Anti-Refresh Banishment</button>
                </p>
            </span>
            <br>
            <br>
            <input id="region_include_alts" type="checkbox" style="height:initial;"></input>Also banish all alts (will not banish ignored alts)
            <br>
            <input id="region_include_alts_recursive" type="checkbox" style="height:initial;"></input>Recursively include alts of alts.
            <br>
            <input id="region_aggressive_alt_identification" type="checkbox" style="height:initial;"></input>Aggressively identify alts (check to include alts that last logged in 90+ days ago and alts of alts)
        </p>
        <p>
            Reason for this action:
            <br>
            <input type="text" id="change_region_reason" style="width:500px;">
        </p>
    </div>

    <div id="player_tools_alts_vpn_migrate">
        <p>
            Other Player ID: <input type="text" id="ignore_alt_other_id" name="ignore_alt_other_id">
            <button onclick="method_ignore_alt($('#ignore_alt_other_id').spinner('value'))" class="spin_button" style="width:250px;">Ignore (mark as non-alt)</button>
            <button onclick="method_unignore_alt($('#ignore_alt_other_id').spinner('value'))" class="spin_button" style="width:180px;">Un-ignore</button>
        </p>
        <p>
            <button onclick="method_vpn_excuse()" class="spin_button">Allow VPN</button>
            <button onclick="method_vpn_unexcuse()" class="spin_button">Disallow VPN</button>
        </p>
        <p>
            Migration Player ID: <input type="text" id="migrate_account_other_id" name="migrate_account_other_id">
            <button onclick="method_migrate_spin_id($('#migrate_account_other_id').spinner('value'))" class="spin_button" style="width:250px;">Migrate</button>
        </p>
        <p>
            Migration Battlehouse ID: <input type="text" id="migrate_account_battlehouse_id" name="migrate_account_battlehouse_id"><button onclick="method_force_migrate_spin_id()" class="spin_button">Force Migrate</button>
        <p>
            Reason for this action:
            <br>
            <input type="text" id="alts_vpn_migrate_reason" style="width:500px;">
        </p>
        <p>
            <button onclick="method_unmerge_bh_id()" class="spin_button">Unmerge BH IDs</button>
        </p>
    </div>
    <div id="player_tools_ban">
        <p>
            <button onclick="method_ban()" class="spin_button">Ban</button>
            <button onclick="method_unban()" class="spin_button">Unban</button>
            <br>
            <input id="ban_remove_from_map" type="checkbox" style="height:initial;" checked="1"></input>Also remove home base and all quarries from regional map
            <br>
            <input id="ban_include_alts" type="checkbox" style="height:initial;"></input>Also ban all alts. Will not ban ignored alts. Alt accounts must be individually unbanned.
            <br>
            <input id="ban_include_alts_recursive" type="checkbox" style="height:initial;"></input>Recursively include alts of alts. Will not ban ignored alts. Alt accounts must be individually unbanned.
            <br>
            <input id="ban_aggressive_alt_identification" type="checkbox" style="height:initial;"></input>Aggressively identify alts (check to include alts that last logged in 90+ days ago)
        </p>
        <p>
            Reason for this action:
            <br>
            <input type="text" id="ban_reason" style="width:500px;">
        </p>
        <p>
            <input id="ban_public_announce" type="checkbox" style="height:initial;" onclick="if(this.checked) { $('#ban_public_message').removeAttr('disabled'); } else { $('#ban_public_message').attr('disabled', 'disabled'); }"></input>
            Announce the ban in public chat:
            <br>
            <input type="text" id="ban_public_message" style="width:800px;" disabled="disabled" value="%player_name in region %region_name has been banned for hacking. Have a nice day!"></input>
    </div>

    <div id="player_tools_alliance_player">
        <p>
            <button onclick="method_demote_alliance_leader()" class="spin_button">Demote Leader</button>
            <button onclick="method_kick_alliance_member()" class="spin_button">Kick from Clan</button>
        </p>
        <p>
            Change clan name or tag:
            <br>
            <input type="text" id="alliance_new_value" style="width:500px;">
            <button onclick="method_change_alliance_name()" class="spin_button">Change Name</button>
            <button onclick="method_change_alliance_tag()" class="spin_button">Change Tag</button>
        </p>
        <p>
            <button onclick="method_remove_mentor()" class="spin_button">Remove Mentor</button>
        </p>
        <p>
            Rename player:
            <br>
            New Call Sign/Name: <input type="text" id="player_updates_new_alias"> <button onclick="method_change_player_alias()" class="spin_button">Rename</button>
        </p>
        <p>
            Reason for this action:
            <br>
            <input type="text" id="alliance_player_reason" style="width:500px;">
        </p>
    </div>

    <div id="player_tools_privacy">
      <button onclick="method_get_personal_info()" class="spin_button">Get Personal Info</button>
      <button onclick="method_mark_uninstalled()" class="spin_button">Clear Personal Info</button>
      <p>
      Reason for this action:
      <br>
      <input type="text" id="privacy_reason" style="width:500px;">
    </div>

    <div id="player_tools_developer">
      &quot;Developer Flag&quot; enables developer-only features and excludes this player from analytics.<p>
      <button onclick="method_make_developer()" class="spin_button" style="width:200px;">Developer Flag ON</button>
      <button onclick="method_unmake_developer()" class="spin_button" style="width:200px;">Developer Flag OFF</button><p>
      <button onclick="method_chat_official()" class="spin_button" style="width:200px;">Blue Chat Text ON</button>
      <button onclick="method_chat_unofficial()" class="spin_button" style="width:200px;">Blue Chat Text OFF</button>
    <p>
      Reason for this action:
      <br>
      <input type="text" id="make_developer_reason" style="width:500px;">
    </div>

    <div id="player_tools_patron">
      &quot;Patron Flag&quot; enables in-game content and monthly gold.<p>
      <button onclick="method_make_patron(1)" class="spin_button" style="width:200px;">Make Patron (Captain)</button>
      <button onclick="method_make_patron(2)" class="spin_button" style="width:200px;">Make Patron (Major)</button><p>
      <button onclick="method_make_patron(3)" class="spin_button" style="width:200px;">Make Patron (Colonel)</button>
      <button onclick="method_unmake_patron()" class="spin_button" style="width:200px;">Patron OFF</button>
    <p>
      Reason for this action:
      <br>
      <input type="text" id="make_patron_reason" style="width:500px;">
    </div>
  </div>
</div>

</div> <!-- END mode_player -->

<div id="mode_payment">

<div id="payment_lookup">
FB Payment ID: <input type="text" id="payment_id" name="payment_id" autofocus><button onclick="payment_lookup()" class="spin_button">Lookup</button>
</div>

<hr>

<div id="per_payment" style="position:relative;display:none;">
Status: <span id="payment_status"></span>
<div id="payment_tools" style="display:none;">
<p>
<button id="payment_refund_button" class="spin_button" style="height:33px;">Refund</button>
<button id="payment_resolve_button" class="spin_button" style="height:33px;">Resolve Dispute</button>
    Reason:
<input type="radio" name="payment_resolve_reason" class="spin_radio" value="DENIED_REFUND" checked>Denied Refund</input>
<input type="radio" name="payment_resolve_reason" class="spin_radio" value="GRANTED_REPLACEMENT_ITEM">Gave Item</input>
<input type="radio" name="payment_resolve_reason" class="spin_radio" value="BANNED_USER">Banned User</input>
</div>
<hr>
<textarea id="payment_lookup_output" readonly style="width:100%;height:10%;font-family:monospace;font-size:12px;"></textarea>
</div>  <!-- END per_payment -->

</div> <!-- END mode_payment -->

<div id="mode_chat">
<div id="chat_status" style="position:relative;">
<div id="chat_status_loading">STATUS</div>
<p>
<label><input id="chat_show_automated" type="checkbox" checked="1" style="height:initial;" onclick="refresh_chat();">Show automated reports</label>
<label><input id="chat_show_tier34" type="checkbox" style="height:initial;" onclick="refresh_chat();">Show Tier 3/4 channels</label>
<label><input id="chat_show_one_year_violations" type="checkbox" style="height:initial;" onclick="refresh_chat();">Show only 1 year of violations</label>
<p>
<table id="chat_table" width="100%" style="font-size:12px;"></table>
<br>

</div> <!-- END mode_chat -->

</div> <!-- END mode_payment -->

<div id="mode_server">
<div id="server_status" style="position:relative;">
<div id="server_status_loading">STATUS</div>
<div style="position:absolute;top:0px;right:0px;"><label style="margin:10px;"><input id="auto_refresh_server_status" type="checkbox" checked="1" style="height:initial;"></input>Auto</label><button onclick="refresh_server_status()" style="width:150px;height:30px;">Refresh</button></div>
<p>
<table id="server_status_table" width="100%" style="font-size:11px;padding:0;"></table>
<br>
<button id="scm_up_button" onclick="scm_up()">SCM up</button>
<button id="download_art_button" onclick="download_art()">Download Art</button>
<button id="download_art_button" onclick="compile_client()">Compile Client</button>
<button id="make_gamedata_button" onclick="make_gamedata()">Make Gamedata</button> <span id="make_gamedata_result" style="font-size:12px;"></span>
<input type="text" id="server_start_gen" style="width:30px;" value="00"/> x<input type="text" id="server_start_qty" style="width:30px;" value="1"/>
<button id="server_start_button" onclick="server_start()">START</button> <span></span>

<span style="float:right;"><input type="text" id="setup_ai_base_id" value="1-1002"/><button id="setup_ai_base_button" onclick="setup_ai_base()">Setup AI Bases</button></span>

<p>
<div id="server_graph_area"></div>
</div>
</div> <!-- END mode_server -->

<div id="mode_logs" style="position:relative;">
<div id="log_area_status" style="float:left;line-height:28px;"></div>

    <div id="credits_status_area" style="position:absolute;top:0x;left:200px;">
    <button id="credits_status_button" onclick="refresh_credits()" style="height:30px;float:left;">Get Credits</button>
    <div id="credits_status" style="width:350px;line-height:20px;margin-left:120px;border-style:inset;border-width:2px;padding:2px;color:#008000;"></div>
    <div style="clear:both;"></div>
    </div>


<div style="float:right;">
<button onclick="logs_rewind_one_day()" style="width:120px;height:30px;">Back 1 Day</button>
<button onclick="logs_forward_one_day()" style="width:120px;height:30px;">Forward 1 Day</button>
<button onclick="logs_yesterday()" style="width:120px;height:30px;">Yesterday</button>
<button onclick="logs_today()" style="width:120px;height:30px;">Today</button>
<button onclick="logs_clear()" style="width:120px;height:30px;">Clear</button>
</div>
<div style="clear:both;"></div>

<div style="margin-top:10px;">
<div id="logs_output" style="height:70%;font-family:monospace;font-size:11px;overflow:auto;border-style:inset;border-width:2px;padding:3px;"></div>
</div>

</div> <!-- END mode_logs -->

<div id="loading_dialog" title="Working..." style="display:none;" >
Contacting server...
</div>

<div id="error_dialog" title="Error" style="display:none;background: #ffcccc;" >
<pre><div id="error_dialog_msg" style="font-size:66%;"></div></pre>
</div>

<div id="response_dialog" title="Response" style="display:none;background: #ffffff;" >
<pre><div id="response_dialog_msg" style="font-size:66%;"></div></pre>
</div>

<div id="confirm_dialog" title="Confirm" style="display:none;background: #ffffff;" >
<div id="confirm_dialog_msg">Are you sure?</div>
</div>

<div id="graph_tooltip" style="position:absolute; diplay:none; border: 1px solid #fdd; padding: 2px; background-color: #fee; opacity: 0.8;"></div>

</body></html>
